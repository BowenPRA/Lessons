<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Cambridge Connections: An educational word association game.">
    <title>Cambridge Connections</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;700;800&family=Plus+Jakarta+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        :root {
            /* --- THEME: Cosmic Classroom --- */
            --bg-deep: #0f172a;
            --bg-surface: rgba(30, 41, 59, 0.7);
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            
            --accent-cyan: #22d3ee;
            --accent-glow: rgba(34, 211, 238, 0.5);
            
            --tile-bg: #ffffff;
            --tile-text: #0f172a;
            --tile-selected-bg: #475569;
            --tile-selected-text: #ffffff;

            /* Category Gradients */
            --cat-yellow: linear-gradient(135deg, #fbbf24, #d97706);
            --cat-green: linear-gradient(135deg, #34d399, #059669);
            --cat-blue: linear-gradient(135deg, #22d3ee, #0891b2);
            --cat-purple: linear-gradient(135deg, #c084fc, #7c3aed);

            --anim-speed: 0.3s;
            --border-radius: 12px;
            --sidebar-width: 280px;
        }

        /* --- RESET & BASE --- */
        * { box-sizing: border-box; margin: 0; padding: 0; user-select: none; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--bg-deep);
            color: var(--text-primary);
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            display: flex;
        }

        /* --- BACKGROUND FX --- */
        .ambient-bg {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
            background: radial-gradient(circle at 15% 50%, #1e1b4b, transparent 25%),
                        radial-gradient(circle at 85% 30%, #312e81, transparent 25%);
            opacity: 0.6;
        }

        /* --- LAYOUT --- */
        .app-layout {
            display: flex;
            width: 100%;
            height: 100%;
            max-width: 1920px;
            margin: 0 auto;
        }

        /* --- SIDEBAR --- */
        .sidebar {
            width: var(--sidebar-width);
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(12px);
            border-right: 1px solid rgba(255,255,255,0.05);
            display: flex;
            flex-direction: column;
            padding: 1.5rem;
            z-index: 10;
        }

        .brand {
            font-family: 'Outfit', sans-serif;
            font-weight: 800;
            font-size: 1.5rem;
            line-height: 1;
            margin-bottom: 2rem;
            color: white;
            letter-spacing: -0.5px;
        }
        .brand span { color: var(--accent-cyan); }

        .level-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            overflow-y: auto;
            flex: 1;
        }

        .level-btn {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: 8px;
            background: transparent;
            border: 1px solid transparent;
            color: var(--text-secondary);
            font-family: 'Outfit', sans-serif;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
            width: 100%;
        }

        .level-btn:hover { background: rgba(255,255,255,0.05); color: white; }
        
        .level-btn.active {
            background: rgba(34, 211, 238, 0.1);
            border-color: rgba(34, 211, 238, 0.3);
            color: var(--accent-cyan);
            box-shadow: 0 0 15px rgba(34, 211, 238, 0.1);
        }

        /* --- MAIN ARENA --- */
        .arena {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center; /* Vertical Center */
            padding: 1rem 2rem;
            position: relative;
            overflow-y: auto;
        }

        .game-wrapper {
            width: 100%;
            max-width: 800px;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        /* --- HEADER AREA --- */
        .game-header {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            text-align: center;
        }

        .game-title {
            font-family: 'Outfit', sans-serif;
            font-size: clamp(1.8rem, 4vw, 2.5rem);
            font-weight: 800;
            color: white;
            margin: 0;
            line-height: 1.1;
        }

        .game-subtitle {
            font-size: 1rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .mistakes-container {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 0.5rem;
        }
        
        .mistakes-label {
            text-transform: uppercase;
            font-weight: 700;
            font-size: 0.75rem;
            letter-spacing: 1px;
            color: var(--text-secondary);
        }

        .pip {
            width: 12px; height: 12px;
            border-radius: 50%;
            background: var(--text-secondary);
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .pip.active { background: var(--text-secondary); opacity: 0.3; transform: scale(0.8); } /* Lost life */
        .pip.remaining { background: var(--accent-cyan); box-shadow: 0 0 8px var(--accent-cyan); }
        .pip.infinite { background: #fbbf24; box-shadow: 0 0 10px #fbbf24; }

        /* --- GRID SYSTEM --- */
        .grid-area {
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 100%;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            width: 100%;
        }

        /* --- TILES --- */
        .tile {
            background: var(--tile-bg);
            color: var(--tile-text);
            border: none;
            border-radius: var(--border-radius);
            aspect-ratio: 1.8/1; /* Rectangular for words */
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Outfit', sans-serif;
            font-weight: 700;
            font-size: clamp(0.75rem, 1.5vw, 1.1rem);
            text-transform: uppercase;
            text-align: center;
            padding: 4px 8px;
            cursor: pointer;
            position: relative;
            transition: transform 0.1s, background-color 0.2s, color 0.2s;
            box-shadow: 0 4px 0 #cbd5e1;
            line-height: 1.1;
            user-select: none;
        }

        .tile:hover { transform: translateY(-2px); }
        .tile:active { transform: translateY(2px); box-shadow: 0 0 0; }
        
        .tile.selected {
            background: var(--tile-selected-bg);
            color: var(--tile-selected-text);
            box-shadow: 0 4px 0 #1e293b;
            transform: translateY(-2px);
        }
        .tile.selected:active { transform: translateY(2px); box-shadow: none; }

        .tile:disabled { cursor: not-allowed; opacity: 0.7; }

        /* Keyboard Focus */
        .tile:focus-visible { outline: 3px solid var(--accent-cyan); outline-offset: 2px; }

        /* Animations */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        .shake { animation: shake 0.4s ease-in-out; }

        @keyframes popIn {
            from { opacity: 0; transform: scale(0.8) translateY(10px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }

        /* --- SOLVED ROWS --- */
        .solved-row {
            width: 100%;
            border-radius: var(--border-radius);
            padding: 10px 16px;
            text-align: center;
            color: white;
            animation: popIn 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
            position: relative;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .solved-header {
            display: flex;
            flex-direction: column;
            align-items: center;
            pointer-events: none; /* Let clicks pass to row */
        }

        .solved-category { font-family: 'Outfit'; font-weight: 800; text-transform: uppercase; font-size: 1rem; margin-bottom: 2px; }
        .solved-words { font-size: 0.9rem; opacity: 0.95; font-weight: 500; }
        
        /* Educational Note Drawer */
        .edu-note {
            background: rgba(0,0,0,0.2);
            margin-top: 8px;
            padding: 0 12px;
            border-radius: 8px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease, padding 0.3s ease;
            text-align: center;
            font-size: 0.9rem;
            color: rgba(255,255,255,0.9);
            line-height: 1.4;
        }
        
        .solved-row:hover { filter: brightness(1.1); }
        .solved-row.expanded .edu-note { max-height: 100px; padding: 10px 12px; }
        .solved-row::after {
            content: '\f078'; /* FontAwesome chevron */
            font-family: "Font Awesome 6 Free"; font-weight: 900;
            position: absolute; right: 15px; top: 15px;
            font-size: 0.8rem; transition: transform 0.3s;
        }
        .solved-row.expanded::after { transform: rotate(180deg); }

        /* --- CONTROLS --- */
        .controls {
            display: flex;
            gap: 10px;
            width: 100%;
            margin-top: 10px;
        }

        .btn {
            padding: 14px;
            border-radius: var(--border-radius);
            border: 1px solid rgba(255,255,255,0.1);
            background: rgba(255,255,255,0.05);
            color: white;
            font-family: 'Outfit', sans-serif;
            font-weight: 700;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.2s;
            flex: 1;
            font-size: 0.85rem;
            letter-spacing: 0.5px;
        }

        .btn:hover:not(:disabled) { background: rgba(255,255,255,0.15); transform: translateY(-2px); }
        .btn:active:not(:disabled) { transform: translateY(0); }
        
        .btn-submit {
            flex: 2;
            background: #334155;
            color: #94a3b8;
            border: none;
            cursor: default;
        }

        .btn-submit.active {
            background: white;
            color: #0f172a;
            box-shadow: 0 0 15px rgba(255,255,255,0.2);
            cursor: pointer;
            animation: pulse 2s infinite;
        }

        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255,255,255,0.4); } 70% { box-shadow: 0 0 0 10px transparent; } 100% { box-shadow: 0 0 0 0 transparent; } }

        /* --- TOAST --- */
        .toast {
            position: fixed; top: 10%; left: 50%; transform: translateX(-50%) translateY(-20px);
            background: #0f172a; color: white; padding: 12px 24px; border-radius: 50px;
            font-family: 'Outfit'; font-weight: 700; z-index: 100;
            opacity: 0; pointer-events: none; transition: all 0.3s;
            border: 2px solid #334155; box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            display: flex; align-items: center; gap: 8px;
        }
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
        .toast.warn { border-color: #fbbf24; color: #fbbf24; }

        /* --- MODAL --- */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.85);
            backdrop-filter: blur(5px); z-index: 200;
            display: none; align-items: center; justify-content: center;
        }
        .modal-card {
            background: white; color: #0f172a; padding: 2rem; border-radius: 20px;
            text-align: center; max-width: 400px; width: 90%;
            animation: popIn 0.3s;
        }
        .modal-card h2 { font-family: 'Outfit'; font-size: 2rem; margin-bottom: 0.5rem; }
        .modal-card p { color: #64748b; margin-bottom: 1.5rem; }
        .modal-actions { display: flex; flex-direction: column; gap: 10px; }
        .btn-modal { width: 100%; padding: 12px; border-radius: 10px; border: none; font-weight: 700; cursor: pointer; }
        .btn-primary { background: #0f172a; color: white; }
        .btn-secondary { background: #e2e8f0; color: #334155; }
        
        /* Confetti Canvas */
        #confetti { position: fixed; inset: 0; pointer-events: none; z-index: 150; }

        /* --- RESPONSIVE ADJUSTMENTS --- */
        @media (max-width: 900px) {
            .app-layout { flex-direction: column; }
            .sidebar { 
                width: 100%; height: auto; 
                flex-direction: row; align-items: center; 
                padding: 10px 16px; 
                border-bottom: 1px solid rgba(255,255,255,0.1);
                border-right: none;
                gap: 16px;
            }
            .brand { margin: 0; font-size: 1.2rem; }
            .level-list { flex-direction: row; overflow-x: auto; padding-bottom: 0; }
            .level-btn { white-space: nowrap; width: auto; padding: 8px 12px; font-size: 0.85rem; }
            .arena { padding: 1rem; }
            .game-title { font-size: 1.5rem; }
            .tile { font-size: 0.8rem; aspect-ratio: 4/3; }
        }

        /* Short screens (laptops/landscape mobile) */
        @media (max-height: 800px) {
            .brand { display: none; } /* Hide brand in sidebar on short screens to save space */
            .sidebar { padding-top: 1rem; }
            .game-wrapper { gap: 0.8rem; }
            .game-header { margin-bottom: 0; }
            .tile { padding: 2px; }
        }
    </style>
</head>
<body>

    <div class="ambient-bg"></div>
    <canvas id="confetti"></canvas>

    <div id="aria-announcer" class="sr-only" aria-live="polite" style="position:absolute; width:1px; height:1px; overflow:hidden; clip:rect(0,0,0,0);"></div>

    <div id="toast" class="toast"><i class="fa-solid fa-circle-exclamation"></i> <span id="toast-msg">Message</span></div>

    <div class="app-layout">
        <nav class="sidebar" aria-label="Level Select">
            <div class="brand">Cambridge <span>Connections</span></div>
            <div class="level-list" id="level-list">
                </div>
        </nav>

        <main class="arena">
            <div class="game-wrapper">
                
                <header class="game-header">
                    <h1 class="game-title" id="display-title">Title</h1>
                    <div class="mistakes-container" aria-label="Mistakes remaining">
                        <span class="mistakes-label">Mistakes:</span>
                        <div class="pip remaining"></div>
                        <div class="pip remaining"></div>
                        <div class="pip remaining"></div>
                        <div class="pip remaining"></div>
                    </div>
                </header>

                <div class="grid-area">
                    <div id="solved-stack"></div>
                    
                    <div id="grid" class="grid"></div>
                </div>

                <div class="controls">
                    <button class="btn" id="btn-shuffle" aria-label="Shuffle Tiles"><i class="fa-solid fa-shuffle"></i></button>
                    <button class="btn" id="btn-deselect" aria-label="Deselect All">Deselect</button>
                    <button class="btn btn-submit" id="btn-submit" disabled>Submit</button>
                </div>
            </div>
        </main>
    </div>

    <div class="modal-overlay" id="end-modal">
        <div class="modal-card">
            <h2 id="modal-title">Splendid!</h2>
            <p id="modal-desc">You cleared the board.</p>
            <div class="modal-actions" id="modal-actions">
                </div>
        </div>
    </div>

<script>
/**
 * Cambridge Connections - Production Build
 * Optimized for robustness, accessibility, and educational value.
 */

/* --- DATA: REWRITTEN FOR EDUCATIONAL CLARITY (SPOILER-FREE) --- */
const DB = [
    {
        title: "The Primary Mix",
        icon: "fa-palette",
        color: "#fbbf24",
        groups: [
            { category: "Primary Colors", color: "var(--cat-yellow)", items: ["RED", "BLUE", "YELLOW", "GREEN"], note: "The fundamental pigments from which most other hues are mixed." },
            { category: "Number Homophones", color: "var(--cat-green)", items: ["WON", "TOO", "FOR", "ATE"], note: "Words that are phonetically identical to the numerals 1, 2, 4, and 8." },
            { category: "School Stationery", color: "var(--cat-blue)", items: ["PEN", "PENCIL", "BOOK", "RULER"], note: "Essential tools found in a student's pencil case." },
            { category: "Circular Objects", color: "var(--cat-purple)", items: ["BALL", "RING", "COIN", "WHEEL"], note: "Everyday items defined by their round geometric shape." }
        ]
    },
    {
        title: "Rhyme Time",
        icon: "fa-music",
        color: "#34d399",
        groups: [
            { category: "Wild Mammals", color: "var(--cat-yellow)", items: ["LION", "TIGER", "MONKEY", "ZEBRA"], note: "Non-domesticated mammals typically found in nature reserves." },
            { category: "Edible Fruit", color: "var(--cat-green)", items: ["APPLE", "BANANA", "LEMON", "GRAPE"], note: "Common produce containing seeds, often sweet or sour." },
            { category: "2D Shapes", color: "var(--cat-blue)", items: ["CIRCLE", "TRIANGLE", "OVAL", "RECTANGLE"], note: "Flat geometric figures defined by lines and curves." },
            { category: "Rhymes with BEAR", color: "var(--cat-purple)", items: ["PEAR", "CHAIR", "HAIR", "SQUARE"], note: "Words ending with the 'air' sound (/ɛə/)." }
        ]
    },
    {
        title: "Safety & Nature",
        icon: "fa-shield-heart",
        color: "#f472b6",
        groups: [
            { category: "Diverse Habitat Animals", color: "var(--cat-yellow)", items: ["WOLF", "CAMEL", "WHALE", "PENGUIN"], note: "Creatures adapted to extreme environments (Desert, Ocean, Ice, Forest)." },
            { category: "Sensory Organs", color: "var(--cat-green)", items: ["EYES", "EARS", "TONGUE", "SKIN"], note: "Biological parts responsible for Sight, Sound, Taste, and Touch." },
            { category: "Computer Hardware", color: "var(--cat-blue)", items: ["TABLET", "SCREEN", "MOUSE", "LAPTOP"], note: "Physical devices used to input or view digital data." },
            { category: "Types of Bullying", color: "var(--cat-purple)", items: ["CYBER", "VERBAL", "PHYSICAL", "SOCIAL"], note: "Specific categories of harmful behavior discussed in PSHE." }
        ]
    },
    {
        title: "Sweet Space",
        icon: "fa-rocket",
        color: "#22d3ee",
        groups: [
            { category: "Noble/Elemental Gases", color: "var(--cat-yellow)", items: ["OXYGEN", "NEON", "HELIUM", "ARGON"], note: "Chemical elements that exist as gas at room temperature." },
            { category: "Heavy Metals", color: "var(--cat-green)", items: ["IRON", "GOLD", "LEAD", "MERCURY"], note: "Dense, conductive elements found on the periodic table." },
            { category: "Solar System Planets", color: "var(--cat-blue)", items: ["VENUS", "JUPITER", "SATURN", "NEPTUNE"], note: "Major celestial bodies orbiting our Sun." },
            { category: "Space-Themed Candy", color: "var(--cat-purple)", items: ["MARS", "MILKY WAY", "SNICKERS", "HERSHEYS"], note: "Famous chocolate bars (some sharing names with cosmic concepts)." }
        ]
    },
    {
        title: "Sound It Out",
        icon: "fa-ear-listen",
        color: "#a855f7",
        groups: [
            { category: "Insects", color: "var(--cat-yellow)", items: ["ANT", "MOTH", "WASP", "FLY"], note: "Small invertebrates with six legs." },
            { category: "Facial Features", color: "var(--cat-green)", items: ["NOSE", "CHIN", "CHEEK", "LIP"], note: "Distinct parts of the human face." },
            { category: "Water Features", color: "var(--cat-blue)", items: ["POND", "LAKE", "STREAM", "RIVER"], note: "Bodies of water found in inland geography." },
            { category: "Letter Homophones", color: "var(--cat-purple)", items: ["BEE", "EYE", "SEA", "PEA"], note: "Words that sound exactly like the letters B, I, C, and P." }
        ]
    },
    {
        title: "Shape Shifter",
        icon: "fa-shapes",
        color: "#fb7185",
        groups: [
            { category: "Magnetic Materials", color: "var(--cat-yellow)", items: ["IRON", "NICKEL", "COBALT", "STEEL"], note: "The specific group of metals attracted to magnets." },
            { category: "Lab Glassware", color: "var(--cat-green)", items: ["BEAKER", "FLASK", "FUNNEL", "CYLINDER"], note: "Vessels used in science labs to hold liquids." },
            { category: "3D Solids", color: "var(--cat-blue)", items: ["SPHERE", "CUBE", "CONE", "PRISM"], note: "Objects with height, width, and depth." },
            { category: "Prefix: MICRO-", color: "var(--cat-purple)", items: ["SCOPE", "WAVE", "PHONE", "CHIP"], note: "Common words beginning with a prefix meaning 'extremely small'." }
        ]
    },
    {
        title: "The Mastermind",
        icon: "fa-brain",
        color: "#60a5fa",
        groups: [
            { category: "Things in Pairs", color: "var(--cat-yellow)", items: ["LUNGS", "KIDNEYS", "POLES", "SCISSORS"], note: "Objects or organs that naturally come in sets of two." },
            { category: "Growth Verbs", color: "var(--cat-green)", items: ["DEVELOP", "MATURE", "SCALE", "BLOOM"], note: "Words describing the process of getting bigger or advancing." },
            { category: "Anatomy Homophones", color: "var(--cat-blue)", items: ["MUSSEL", "NAVAL", "HART", "HEAL"], note: "Words sounding like Muscle, Navel, Heart, and Heel." },
            { category: "Palindromes", color: "var(--cat-purple)", items: ["RADAR", "LEVEL", "ROTOR", "EYE"], note: "Words that are spelled the same forwards and backwards." }
        ]
    }
];

/* --- STATE MANAGEMENT --- */
const state = {
    currentGame: 0,
    items: [], // { word, category, color, note, id }
    selected: [], // Array of indices
    solved: [], // Array of category names
    mistakes: 0,
    maxMistakes: 4,
    isProcessing: false, // Prevents clicks during animation
    infiniteMode: false
};

/* --- DOM CACHE --- */
const dom = {
    grid: document.getElementById('grid'),
    solvedStack: document.getElementById('solved-stack'),
    levelList: document.getElementById('level-list'),
    displayTitle: document.getElementById('display-title'),
    pips: document.querySelectorAll('.pip'),
    submitBtn: document.getElementById('btn-submit'),
    toast: document.getElementById('toast'),
    toastMsg: document.getElementById('toast-msg'),
    modal: document.getElementById('end-modal'),
    modalTitle: document.getElementById('modal-title'),
    modalDesc: document.getElementById('modal-desc'),
    modalActions: document.getElementById('modal-actions'),
    announcer: document.getElementById('aria-announcer')
};

/* --- INITIALIZATION --- */
function init() {
    renderSidebar();
    loadGame(0);
    
    // Event Listeners
    document.getElementById('btn-shuffle').addEventListener('click', () => {
        if(state.isProcessing || state.solved.length === 4) return;
        shuffleGrid();
    });
    
    document.getElementById('btn-deselect').addEventListener('click', () => {
        if(state.isProcessing) return;
        state.selected = [];
        renderSelection();
    });
    
    dom.submitBtn.addEventListener('click', handleSubmit);
    
    // Resize listener for confetti
    window.addEventListener('resize', () => {
        const canvas = document.getElementById('confetti');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
    });
}

function renderSidebar() {
    dom.levelList.innerHTML = '';
    DB.forEach((game, idx) => {
        const btn = document.createElement('button');
        btn.className = `level-btn ${idx === 0 ? 'active' : ''}`;
        btn.innerHTML = `<i class="fa-solid ${game.icon}" style="color:${game.color}; width:20px; text-align:center;"></i> ${game.title}`;
        btn.onclick = () => loadGame(idx);
        dom.levelList.appendChild(btn);
    });
}

/* --- GAME LOGIC --- */
function loadGame(idx) {
    // Update Sidebar UI
    document.querySelectorAll('.level-btn').forEach((b, i) => {
        b.classList.toggle('active', i === idx);
    });

    state.currentGame = idx;
    state.mistakes = 0;
    state.selected = [];
    state.solved = [];
    state.items = [];
    state.isProcessing = false;
    state.infiniteMode = false;

    dom.displayTitle.innerText = DB[idx].title;
    
    // Flatten data
    DB[idx].groups.forEach(group => {
        group.items.forEach(word => {
            state.items.push({
                word: word,
                category: group.category,
                color: group.color,
                note: group.note,
                id: Math.random().toString(36).substr(2, 9)
            });
        });
    });

    // Reset UI
    resetLives();
    dom.solvedStack.innerHTML = '';
    dom.modal.style.display = 'none';
    
    shuffleGrid(true); // Initial render with animation
}

function resetLives() {
    dom.pips.forEach(pip => {
        pip.className = 'pip remaining';
        pip.style.background = '';
        pip.style.boxShadow = '';
    });
}

function renderGrid(animate = false) {
    dom.grid.innerHTML = '';
    
    state.items.forEach((item, index) => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = `tile ${state.selected.includes(index) ? 'selected' : ''}`;
        btn.textContent = item.word;
        btn.onclick = () => handleTileClick(index);
        
        // Staggered Entrance
        if (animate) {
            btn.style.animation = `popIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) ${index * 0.05}s backwards`;
        }
        
        dom.grid.appendChild(btn);
    });
    
    updateSubmitBtn();
}

function shuffleGrid(animate = false) {
    // Fisher-Yates Shuffle
    for (let i = state.items.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [state.items[i], state.items[j]] = [state.items[j], state.items[i]];
    }
    
    // Maintain selection by re-finding the moved items (optional, but nice UX)
    // For simplicity here, we clear selection on shuffle to prevent logic bugs
    state.selected = [];
    
    renderGrid(animate);
}

function handleTileClick(index) {
    if (state.isProcessing) return;

    if (state.selected.includes(index)) {
        state.selected = state.selected.filter(i => i !== index);
    } else {
        if (state.selected.length < 4) {
            state.selected.push(index);
        }
    }
    renderSelection();
}

function renderSelection() {
    const tiles = dom.grid.children;
    Array.from(tiles).forEach((tile, i) => {
        tile.classList.toggle('selected', state.selected.includes(i));
    });
    updateSubmitBtn();
}

function updateSubmitBtn() {
    if (state.selected.length === 4) {
        dom.submitBtn.disabled = false;
        dom.submitBtn.classList.add('active');
    } else {
        dom.submitBtn.disabled = true;
        dom.submitBtn.classList.remove('active');
    }
}

/* --- SUBMISSION HANDLING --- */
function handleSubmit() {
    if (state.selected.length !== 4 || state.isProcessing) return;
    
    state.isProcessing = true;
    
    // Get selected items
    const selection = state.selected.map(i => state.items[i]);
    const firstCat = selection[0].category;
    const isMatch = selection.every(item => item.category === firstCat);

    if (isMatch) {
        handleSuccess(selection[0]);
    } else {
        handleMistake(selection);
    }
}

function handleSuccess(groupInfo) {
    announce(`Correct! You found the ${groupInfo.category} group.`);
    
    // 1. Remove from active items
    const remainingItems = state.items.filter((_, idx) => !state.selected.includes(idx));
    state.items = remainingItems;
    state.selected = [];
    state.solved.push(groupInfo.category);

    // 2. Add Solved Row
    addSolvedRow(groupInfo);

    // 3. Re-render grid
    renderGrid(false);
    
    state.isProcessing = false;
    
    // Check Win
    if (state.items.length === 0) {
        setTimeout(triggerWin, 600);
    }
}

function addSolvedRow(info) {
    const row = document.createElement('div');
    row.className = 'solved-row';
    row.style.background = info.color;
    row.innerHTML = `
        <div class="solved-header">
            <div class="solved-category">${info.category}</div>
            <div class="solved-words">${DB[state.currentGame].groups.find(g => g.category === info.category).items.join(', ')}</div>
        </div>
        <div class="edu-note">${info.note}</div>
    `;
    
    // Click to expand note
    row.onclick = function() {
        this.classList.toggle('expanded');
    };
    
    dom.solvedStack.appendChild(row);
}

function handleMistake(selection) {
    // Check "One Away"
    const counts = {};
    selection.forEach(i => counts[i.category] = (counts[i.category] || 0) + 1);
    const oneAway = Object.values(counts).includes(3);

    // Visual Shake
    state.selected.forEach(idx => {
        dom.grid.children[idx].classList.add('shake');
    });

    if (!state.infiniteMode) {
        state.mistakes++;
        updateLives();
    }

    setTimeout(() => {
        Array.from(dom.grid.children).forEach(t => t.classList.remove('shake'));
        
        if (oneAway) showToast("One away...", "warn");
        else showToast("Not quite!", "normal");

        state.isProcessing = false;
        announce(oneAway ? "Incorrect. You are one away." : "Incorrect.");

        if (!state.infiniteMode && state.mistakes >= state.maxMistakes) {
            triggerLose();
        }
    }, 500);
}

function updateLives() {
    for (let i = 0; i < state.maxMistakes; i++) {
        if (i < state.mistakes) {
            dom.pips[i].classList.remove('remaining');
            dom.pips[i].classList.add('active');
        }
    }
}

function showToast(msg, type) {
    dom.toastMsg.innerText = msg;
    dom.toast.className = `toast show ${type}`;
    setTimeout(() => dom.toast.classList.remove('show'), 2000);
}

function announce(text) {
    dom.announcer.innerText = text;
}

/* --- MODALS & END GAME --- */
function triggerWin() {
    startConfetti();
    dom.modalTitle.innerText = "Splendid!";
    dom.modalDesc.innerText = "You have cleared the board.";
    
    dom.modalActions.innerHTML = `
        <button class="btn-modal btn-secondary" onclick="document.getElementById('end-modal').style.display='none'">Review Board</button>
        <button class="btn-modal btn-primary" onclick="loadGame((state.currentGame + 1) % DB.length)">Next Level</button>
    `;
    
    dom.modal.style.display = 'flex';
}

function triggerLose() {
    dom.modalTitle.innerText = "Out of Mistakes";
    dom.modalDesc.innerText = "Don't give up! What would you like to do?";
    
    dom.modalActions.innerHTML = `
        <button class="btn-modal btn-primary" onclick="enableInfinite()">Keep Playing (Infinite Lives)</button>
        <button class="btn-modal btn-secondary" onclick="revealAnswers()">Reveal Answers</button>
        <button class="btn-modal btn-secondary" onclick="loadGame(state.currentGame)">Try Again</button>
    `;
    
    dom.modal.style.display = 'flex';
}

function enableInfinite() {
    state.infiniteMode = true;
    state.isProcessing = false;
    dom.modal.style.display = 'none';
    
    dom.pips.forEach(p => {
        p.className = 'pip infinite';
    });
    announce("Infinite lives enabled.");
}

function revealAnswers() {
    dom.modal.style.display = 'none';
    dom.grid.innerHTML = '';
    
    // Find unsolved groups
    const allGroups = DB[state.currentGame].groups;
    const unsolved = allGroups.filter(g => !state.solved.includes(g.category));
    
    unsolved.forEach(g => addSolvedRow(g));
}

/* --- CONFETTI FX (Lightweight) --- */
function startConfetti() {
    const canvas = document.getElementById('confetti');
    const ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    
    const particles = [];
    const colors = ['#fbbf24', '#34d399', '#22d3ee', '#f472b6'];
    
    for(let i=0; i<150; i++) {
        particles.push({
            x: canvas.width/2, y: canvas.height/2,
            vx: (Math.random()-0.5)*20, vy: (Math.random()-0.5)*20,
            s: Math.random()*8+4, c: colors[Math.floor(Math.random()*colors.length)]
        });
    }
    
    function tick() {
        ctx.clearRect(0,0,canvas.width,canvas.height);
        let active = false;
        particles.forEach(p => {
            p.x += p.vx; p.y += p.vy; p.vy += 0.5; p.vx *= 0.94; p.vy *= 0.94;
            if(p.y < canvas.height) active = true;
            ctx.fillStyle = p.c; ctx.fillRect(p.x, p.y, p.s, p.s);
        });
        if(active) requestAnimationFrame(tick);
    }
    tick();
}

// Start
init();

</script>
</body>
</html>
