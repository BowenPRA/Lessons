<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Cambridge Connections: An educational word association game.">
    <title>Cambridge Connections</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;700;800&family=Plus+Jakarta+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        :root {
            /* --- THEME COLORS --- */
            --bg-deep: #0f172a;
            --bg-panel: rgba(30, 41, 59, 0.7);
            --text-primary: #f8fafc;
            --text-muted: #94a3b8;
            
            /* Game Colors */
            --tile-bg: #ffffff;
            --tile-text: #0f172a;
            --tile-selected-bg: #38bdf8; /* Sky Blue */
            --tile-selected-text: #0c4a6e;
            
            /* Category Colors (High Contrast for Projectors) */
            --cat-yellow: #f59e0b; /* Amber 500 */
            --cat-green: #10b981; /* Emerald 500 */
            --cat-blue: #0ea5e9;  /* Sky 500 */
            --cat-purple: #8b5cf6; /* Violet 500 */

            /* Lives */
            --heart-active: #ef4444;
            --heart-empty: #334155;

            /* Dimensions */
            --sidebar-width: 280px;
            --header-height: 60px; /* For mobile */
        }

        /* --- BASE RESET --- */
        * { box-sizing: border-box; margin: 0; padding: 0; user-select: none; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--bg-deep);
            color: var(--text-primary);
            height: 100vh; /* Fallback */
            height: 100dvh; /* Dynamic viewport height */
            width: 100vw;
            overflow: hidden;
            display: flex;
        }

        /* --- BACKGROUND ANIMATION --- */
        .ambient-bg {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
            background: 
                radial-gradient(circle at 15% 50%, rgba(56, 189, 248, 0.15), transparent 25%),
                radial-gradient(circle at 85% 30%, rgba(139, 92, 246, 0.15), transparent 25%);
            animation: pulseBg 10s ease-in-out infinite alternate;
        }
        @keyframes pulseBg { 0% { opacity: 0.8; } 100% { opacity: 1; } }

        /* --- LAYOUT --- */
        .app-container {
            display: flex;
            width: 100%;
            height: 100%;
            max-width: 1920px;
            margin: 0 auto;
        }

        /* --- SIDEBAR (LEVEL SELECT) --- */
        .sidebar {
            width: var(--sidebar-width);
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(12px);
            border-right: 1px solid rgba(255,255,255,0.1);
            display: flex;
            flex-direction: column;
            padding: 1.5rem;
            gap: 1rem;
            z-index: 20;
            transition: transform 0.3s ease;
        }

        .brand {
            font-family: 'Outfit', sans-serif;
            font-weight: 800;
            font-size: 1.5rem;
            line-height: 1;
            color: white;
            margin-bottom: 1rem;
        }
        .brand span { color: var(--tile-selected-bg); }

        .level-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            overflow-y: auto;
            flex: 1;
            padding-right: 5px; /* Space for scrollbar */
        }

        /* Custom Scrollbar for sidebar */
        .level-list::-webkit-scrollbar { width: 4px; }
        .level-list::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 4px; }

        .level-btn {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: 8px;
            background: transparent;
            border: 1px solid transparent;
            color: var(--text-muted);
            font-family: 'Outfit', sans-serif;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: left;
            font-size: 0.95rem;
        }

        .level-btn:hover { background: rgba(255,255,255,0.05); color: white; }
        
        .level-btn.active {
            background: rgba(56, 189, 248, 0.1);
            border-color: rgba(56, 189, 248, 0.3);
            color: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        /* --- MAIN GAME ARENA --- */
        .arena {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center; /* Center vertically */
            padding: 1rem 2rem;
            position: relative;
            height: 100%;
        }

        .game-board-wrapper {
            width: 100%;
            max-width: 850px;
            /* Flex column to ensure it fits without scrolling */
            display: flex;
            flex-direction: column;
            gap: 1rem;
            /* Limit height to ensure buttons stay visible */
            max-height: 100%; 
        }

        /* Header Area */
        .game-header {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            flex-shrink: 0;
        }

        .lives-container {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(0,0,0,0.3);
            padding: 6px 16px;
            border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .lives-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 700;
            color: var(--text-muted);
            margin-right: 4px;
        }

        .heart-icon {
            font-size: 1.1rem;
            color: var(--heart-active);
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            filter: drop-shadow(0 0 5px rgba(239, 68, 68, 0.5));
        }
        
        /* Heartbeat Animation */
        .heart-icon.active { animation: heartbeat 2s infinite; }
        @keyframes heartbeat {
            0% { transform: scale(1); }
            5% { transform: scale(1.1); }
            10% { transform: scale(1); }
            15% { transform: scale(1.1); }
            20% { transform: scale(1); }
            100% { transform: scale(1); }
        }

        .heart-icon.lost {
            color: var(--heart-empty);
            filter: none;
            transform: scale(0.8);
            animation: none;
        }

        h2.game-title {
            font-family: 'Outfit', sans-serif;
            font-size: clamp(1.5rem, 4vh, 2.5rem);
            font-weight: 800;
            color: white;
            text-shadow: 0 4px 10px rgba(0,0,0,0.3);
            text-align: center;
        }

        /* --- GRID SYSTEM --- */
        .play-area {
            flex: 1; /* Take remaining space */
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-height: 0; /* Allow shrinking */
            gap: 12px;
        }

        .solved-stack {
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 100%;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            width: 100%;
        }

        .tile {
            background: var(--tile-bg);
            color: var(--tile-text);
            border: none;
            border-radius: 12px;
            /* Intelligent Aspect Ratio */
            aspect-ratio: 16/9;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Outfit', sans-serif;
            font-weight: 700;
            font-size: clamp(0.8rem, 1.5vw, 1.1rem);
            text-transform: uppercase;
            text-align: center;
            padding: 4px;
            cursor: pointer;
            box-shadow: 0 4px 0 #cbd5e1;
            transition: transform 0.1s, background 0.2s, color 0.2s;
            position: relative;
            width: 100%;
        }

        .tile:hover { transform: translateY(-2px); box-shadow: 0 6px 0 #cbd5e1; }
        .tile:active { transform: translateY(2px); box-shadow: 0 0 0 #cbd5e1; }

        .tile.selected {
            background: var(--tile-selected-bg);
            color: var(--tile-selected-text);
            box-shadow: 0 4px 0 #0ea5e9;
            transform: translateY(-2px);
            z-index: 2;
        }
        
        /* Accessibility Focus */
        .tile:focus-visible { outline: 3px solid white; outline-offset: 2px; }

        /* Animations */
        .shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake { 10%, 90% { transform: translateX(-2px); } 20%, 80% { transform: translateX(2px); } }

        /* --- SOLVED ROW STYLING --- */
        .solved-row {
            width: 100%;
            padding: 0.8rem 1.2rem;
            border-radius: 10px;
            text-align: center;
            color: white;
            cursor: pointer;
            animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            position: relative;
            transition: filter 0.2s;
        }
        .solved-row:hover { filter: brightness(1.1); }
        
        @keyframes popIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        .solved-category { font-family: 'Outfit', sans-serif; font-weight: 800; font-size: 1.1rem; text-transform: uppercase; margin-bottom: 2px; }
        .solved-words { font-size: 0.9rem; font-weight: 500; opacity: 0.95; }

        /* Educational Note Drawer */
        .teacher-note {
            background: rgba(255,255,255,0.95);
            color: #1e293b;
            margin: 0 -1.2rem;
            padding: 0 1.2rem;
            max-height: 0;
            overflow: hidden;
            transition: all 0.4s ease;
            text-align: left;
            border-bottom-left-radius: 10px;
            border-bottom-right-radius: 10px;
        }
        .solved-row.open .teacher-note {
            margin-top: 0.8rem;
            padding-top: 1rem;
            padding-bottom: 1rem;
            max-height: 200px;
        }
        .note-title { font-weight: 800; font-size: 0.75rem; text-transform: uppercase; color: #64748b; margin-bottom: 4px; display: block; }
        .note-text { font-size: 0.95rem; line-height: 1.4; }

        /* --- CONTROLS --- */
        .controls-bar {
            display: flex;
            gap: 12px;
            width: 100%;
            margin-top: auto; /* Push to bottom of wrapper */
            padding-bottom: 1rem;
        }

        .action-btn {
            flex: 1;
            padding: 14px;
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.1);
            background: rgba(255,255,255,0.05);
            color: white;
            font-family: 'Outfit', sans-serif;
            font-weight: 700;
            text-transform: uppercase;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .action-btn:hover:not(:disabled) { background: rgba(255,255,255,0.15); transform: translateY(-2px); }
        
        .submit-btn {
            flex: 1.5;
            background: #334155;
            color: #94a3b8;
            border: none;
            cursor: not-allowed;
        }
        .submit-btn.ready {
            background: white;
            color: #0f172a;
            cursor: pointer;
            box-shadow: 0 0 15px rgba(255,255,255,0.3);
            animation: pulseBtn 2s infinite;
        }
        @keyframes pulseBtn { 0% { box-shadow: 0 0 0 0 rgba(255,255,255,0.4); } 70% { box-shadow: 0 0 0 10px rgba(255,255,255,0); } 100% { box-shadow: 0 0 0 0 rgba(255,255,255,0); } }

        /* --- TOAST --- */
        .toast {
            position: fixed; top: 10%; left: 50%; transform: translate(-50%, -20px);
            background: #1e293b; color: white; padding: 12px 24px; border-radius: 50px;
            font-family: 'Outfit'; font-weight: 700; border: 2px solid #334155;
            opacity: 0; pointer-events: none; transition: all 0.3s; z-index: 100;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5); display: flex; align-items: center; gap: 10px;
        }
        .toast.visible { transform: translate(-50%, 0); opacity: 1; }
        .toast.warn { border-color: #f59e0b; color: #f59e0b; }

        /* --- MODAL --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); backdrop-filter: blur(5px);
            display: none; align-items: center; justify-content: center; z-index: 1000;
        }
        .modal-card {
            background: white; padding: 2rem; border-radius: 20px; text-align: center;
            max-width: 400px; width: 90%; color: #0f172a;
            animation: popIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .modal-card h2 { font-family: 'Outfit'; font-size: 2rem; margin-bottom: 0.5rem; }
        .modal-actions { margin-top: 1.5rem; display: flex; flex-direction: column; gap: 10px; }
        .modal-btn { padding: 12px; border-radius: 8px; border: none; font-weight: 700; cursor: pointer; font-size: 1rem; }
        .btn-primary { background: #0f172a; color: white; }
        .btn-secondary { background: #e2e8f0; color: #0f172a; }

        /* --- RESPONSIVE MOBILE --- */
        @media (max-width: 900px) {
            .app-container { flex-direction: column; }
            
            .sidebar {
                width: 100%;
                height: auto;
                flex-direction: row;
                align-items: center;
                padding: 0.8rem;
                overflow-x: auto;
                border-right: none;
                border-bottom: 1px solid rgba(255,255,255,0.1);
            }
            
            .brand { font-size: 1.2rem; margin: 0; margin-right: 1rem; white-space: nowrap; }
            .level-list { flex-direction: row; align-items: center; overflow-y: hidden; }
            .level-btn { padding: 8px 12px; font-size: 0.85rem; white-space: nowrap; }
            
            .arena { padding: 0.5rem 1rem; }
            .game-board-wrapper { gap: 0.5rem; }
            .grid { gap: 8px; }
            .tile { font-size: 0.85rem; padding: 2px; }
            
            h2.game-title { font-size: 1.5rem; }
            .controls-bar { padding-bottom: 0; margin-top: 0; }
            .action-btn { padding: 10px; font-size: 0.8rem; }
        }
    </style>
</head>
<body>

    <div class="ambient-bg"></div>
    <canvas id="confetti" style="position:fixed; top:0; left:0; pointer-events:none; z-index:999;"></canvas>

    <div id="toast" class="toast">
        <i class="fa-solid fa-circle-exclamation"></i>
        <span id="toast-text">Alert</span>
    </div>

    <div class="app-container">
        <nav class="sidebar" aria-label="Level Select">
            <div class="brand">
                Cambridge<br><span>Connections</span>
            </div>
            <div class="level-list" id="level-list">
                </div>
        </nav>

        <main class="arena">
            <div class="game-board-wrapper">
                
                <div class="game-header">
                    <div class="lives-container" aria-label="Lives Remaining">
                        <span class="lives-label">Lives</span>
                        <i class="fa-solid fa-heart heart-icon active" id="life-1"></i>
                        <i class="fa-solid fa-heart heart-icon active" id="life-2"></i>
                        <i class="fa-solid fa-heart heart-icon active" id="life-3"></i>
                        <i class="fa-solid fa-heart heart-icon active" id="life-4"></i>
                    </div>
                    <h2 class="game-title" id="game-title">The Primary Mix</h2>
                </div>

                <div class="play-area">
                    <div id="solved-stack" class="solved-stack"></div>
                    <div id="grid" class="grid" role="grid" aria-label="Word Grid"></div>
                </div>

                <div class="controls-bar">
                    <button class="action-btn" id="btn-shuffle" aria-label="Shuffle Words"><i class="fa-solid fa-shuffle"></i></button>
                    <button class="action-btn" id="btn-deselect">Deselect</button>
                    <button class="action-btn submit-btn" id="btn-submit" disabled>Submit</button>
                </div>
            </div>
        </main>
    </div>

    <div class="modal-overlay" id="modal" role="dialog" aria-modal="true">
        <div class="modal-card">
            <h2 id="modal-title">Splendid!</h2>
            <p id="modal-msg" style="color:#64748b; margin-bottom: 20px;">You cleared the board.</p>
            <div class="modal-actions" id="modal-actions">
                </div>
        </div>
    </div>

    <script>
        /**
         * CAMBRIDGE CONNECTIONS
         * A refined, accessible, and responsive word association game.
         */

        // --- DATABASE: EDUCATIONAL & SPOILER-FREE NOTES ---
        const GAMES = [
            {
                title: "The Primary Mix",
                icon: "fa-palette",
                groups: [
                    { category: "Primary Colors", color: "var(--cat-yellow)", items: ["RED", "BLUE", "YELLOW", "GREEN"], note: "In traditional art, Red, Blue, and Yellow are Primary colors. Green is included here as a Secondary color often found in basic sets." },
                    { category: "Number Homophones", color: "var(--cat-green)", items: ["WON", "TOO", "FOR", "ATE"], note: "Homophones are words that sound the same but have different meanings. These sound exactly like the numbers 1, 2, 4, and 8." },
                    { category: "Stationery", color: "var(--cat-blue)", items: ["PEN", "PENCIL", "BOOK", "RULER"], note: "These are standard physical tools used for writing and measuring in a classroom environment." },
                    { category: "Spherical Objects", color: "var(--cat-purple)", items: ["BALL", "MOON", "ORANGE", "GLOBE"], note: "A sphere is a perfectly round 3D geometric object, like a ball or a planet." }
                ]
            },
            {
                title: "Rhyme Time",
                icon: "fa-music",
                groups: [
                    { category: "Rhymes with BEAR", color: "var(--cat-yellow)", items: ["PEAR", "CHAIR", "HAIR", "SQUARE"], note: "Phonics: All these words end with the /ɛə/ sound, despite being spelled differently (ear, air, are)." },
                    { category: "Fruits", color: "var(--cat-green)", items: ["APPLE", "BANANA", "LEMON", "GRAPE"], note: "Botany: These are the fleshy products of trees or other plants that contain seeds and can be eaten." },
                    { category: "2D Shapes", color: "var(--cat-blue)", items: ["CIRCLE", "TRIANGLE", "OVAL", "SQUARE"], note: "Geometry: These are two-dimensional flat shapes defined by lines or curves." },
                    { category: "Wild Mammals", color: "var(--cat-purple)", items: ["LION", "TIGER", "MONKEY", "ZEBRA"], note: "Zoology: These are mammals that typically live in natural environments (the wild) rather than domestication." }
                ]
            },
            {
                title: "Safety & Nature",
                icon: "fa-shield-heart",
                groups: [
                    { category: "Five Senses", color: "var(--cat-yellow)", items: ["SIGHT", "HEARING", "TASTE", "TOUCH"], note: "Biology: These are the faculties by which the body perceives an external stimulus." },
                    { category: "Habitats", color: "var(--cat-green)", items: ["DESERT", "FOREST", "OCEAN", "TUNDRA"], note: "Ecology: A habitat is the natural home or environment of an animal, plant, or other organism." },
                    { category: "Computer Hardware", color: "var(--cat-blue)", items: ["MOUSE", "SCREEN", "KEYBOARD", "TABLET"], note: "ICT: These are the physical parts of a computer system that you can touch." },
                    { category: "Types of Bullying", color: "var(--cat-purple)", items: ["CYBER", "VERBAL", "PHYSICAL", "SOCIAL"], note: "PSHE: Bullying is categorized by how the harm is delivered. Cyber refers to online; Social refers to damaging reputation." }
                ]
            },
            {
                title: "Sweet Space",
                icon: "fa-rocket",
                groups: [
                    { category: "Noble Gases", color: "var(--cat-yellow)", items: ["HELIUM", "NEON", "ARGON", "XENON"], note: "Chemistry: These elements are odorless, colorless gases with very low chemical reactivity." },
                    { category: "Solar System Planets", color: "var(--cat-green)", items: ["VENUS", "JUPITER", "SATURN", "NEPTUNE"], note: "Astronomy: These are celestial bodies orbiting our Sun. (Note: Pluto is a dwarf planet!)." },
                    { category: "Heavy Metals", color: "var(--cat-blue)", items: ["IRON", "GOLD", "LEAD", "MERCURY"], note: "Chemistry: These are dense metallic elements. Uniquely, Mercury is liquid at room temperature." },
                    { category: "Space-Themed Candy", color: "var(--cat-purple)", items: ["MARS", "MILKY WAY", "GALAXY", "ORBIT"], note: "Pop Culture: These famous confectionery brands share names with astronomical concepts." }
                ]
            },
            {
                title: "Sound It Out",
                icon: "fa-ear-listen",
                groups: [
                    { category: "Insects", color: "var(--cat-yellow)", items: ["ANT", "MOTH", "WASP", "FLY"], note: "Biology: Small invertebrates with six legs and usually one or two pairs of wings." },
                    { category: "Facial Features", color: "var(--cat-green)", items: ["NOSE", "CHIN", "CHEEK", "LIP"], note: "Anatomy: Distinct parts of the human face." },
                    { category: "Bodies of Water", color: "var(--cat-blue)", items: ["POND", "LAKE", "STREAM", "RIVER"], note: "Geography: Accumulations of water on the surface of Earth." },
                    { category: "Letter Homophones", color: "var(--cat-purple)", items: ["BEE", "EYE", "SEA", "PEA"], note: "Wordplay: When spoken aloud, these words sound exactly like the letters B, I, C, and P." }
                ]
            },
            {
                title: "Shape Shifter",
                icon: "fa-shapes",
                groups: [
                    { category: "Magnetic Materials", color: "var(--cat-yellow)", items: ["IRON", "NICKEL", "COBALT", "STEEL"], note: "Physics: Only a few metals are magnetic. Steel is an alloy made mostly of Iron." },
                    { category: "Lab Glassware", color: "var(--cat-green)", items: ["BEAKER", "FLASK", "FUNNEL", "CYLINDER"], note: "Science: Equipment made of glass used for scientific experiments." },
                    { category: "3D Shapes", color: "var(--cat-blue)", items: ["SPHERE", "CUBE", "CONE", "PRISM"], note: "Maths: A solid figure or an object or shape that has three dimensions—length, width, and height." },
                    { category: "Prefix: MICRO-", color: "var(--cat-purple)", items: ["SCOPE", "WAVE", "PHONE", "CHIP"], note: "Literacy: The prefix 'Micro-' means small. Microscope, Microwave, Microphone, Microchip." }
                ]
            },
            {
                title: "The Mastermind",
                icon: "fa-brain",
                groups: [
                    { category: "Pairs in the Body", color: "var(--cat-yellow)", items: ["LUNGS", "KIDNEYS", "EYES", "EARS"], note: "Anatomy: Organs or body parts that naturally come in sets of two." },
                    { category: "Growth Verbs", color: "var(--cat-green)", items: ["DEVELOP", "MATURE", "EVOLVE", "BLOOM"], note: "Vocabulary: Verbs that describe the process of growing or changing into a more advanced state." },
                    { category: "Homophone Body Parts", color: "var(--cat-blue)", items: ["MUSSEL", "NAVAL", "HART", "HEAL"], note: "Wordplay: Words that sound like Muscle, Navel, Heart, and Heel." },
                    { category: "Palindromes", color: "var(--cat-purple)", items: ["RADAR", "LEVEL", "ROTOR", "MADAM"], note: "Literacy: A word that reads the same backward as forward." }
                ]
            }
        ];

        // --- STATE MANAGEMENT ---
        const state = {
            gameIndex: 0,
            gridItems: [],
            selectedIndices: [],
            lives: 4,
            isGameOver: false,
            solvedGroups: []
        };

        // --- DOM REFERENCES ---
        const DOM = {
            grid: document.getElementById('grid'),
            solvedStack: document.getElementById('solved-stack'),
            levelList: document.getElementById('level-list'),
            submitBtn: document.getElementById('btn-submit'),
            gameTitle: document.getElementById('game-title'),
            hearts: [
                document.getElementById('life-1'),
                document.getElementById('life-2'),
                document.getElementById('life-3'),
                document.getElementById('life-4')
            ],
            toast: document.getElementById('toast'),
            toastText: document.getElementById('toast-text'),
            modal: document.getElementById('modal'),
            modalTitle: document.getElementById('modal-title'),
            modalMsg: document.getElementById('modal-msg'),
            modalActions: document.getElementById('modal-actions'),
            confetti: document.getElementById('confetti')
        };

        // --- INITIALIZATION ---
        function init() {
            renderSidebar();
            loadGame(0);
            setupListeners();
        }

        function setupListeners() {
            document.getElementById('btn-shuffle').addEventListener('click', shuffleGrid);
            document.getElementById('btn-deselect').addEventListener('click', deselectAll);
            DOM.submitBtn.addEventListener('click', handleSubmit);
            
            // Mobile: Hide toast on click
            DOM.toast.addEventListener('click', () => DOM.toast.classList.remove('visible'));
        }

        function renderSidebar() {
            DOM.levelList.innerHTML = '';
            GAMES.forEach((game, idx) => {
                const btn = document.createElement('button');
                btn.className = `level-btn ${idx === 0 ? 'active' : ''}`;
                btn.innerHTML = `<i class="fa-solid ${game.icon}"></i> ${game.title}`;
                btn.onclick = () => loadGame(idx);
                DOM.levelList.appendChild(btn);
            });
        }

        function loadGame(idx) {
            // Reset State
            state.gameIndex = idx;
            state.lives = 4;
            state.isGameOver = false;
            state.selectedIndices = [];
            state.solvedGroups = [];
            state.gridItems = [];

            // UI Updates
            document.querySelectorAll('.level-btn').forEach((b, i) => {
                b.classList.toggle('active', i === idx);
            });
            DOM.gameTitle.innerText = GAMES[idx].title;
            DOM.solvedStack.innerHTML = '';
            DOM.grid.innerHTML = '';
            DOM.modal.style.display = 'none';
            updateLivesUI();
            updateSubmitBtn();

            // Prepare Data
            const gameData = GAMES[idx];
            gameData.groups.forEach(group => {
                group.items.forEach(word => {
                    state.gridItems.push({
                        word: word,
                        group: group,
                        id: Math.random().toString(36).substr(2, 9)
                    });
                });
            });

            shuffleGrid();
        }

        function renderGrid() {
            DOM.grid.innerHTML = '';
            state.gridItems.forEach((item, displayIdx) => {
                const btn = document.createElement('button');
                btn.className = 'tile';
                if (state.selectedIndices.includes(displayIdx)) {
                    btn.classList.add('selected');
                }
                btn.innerText = item.word;
                btn.onclick = () => handleTileClick(displayIdx);
                DOM.grid.appendChild(btn);
            });
        }

        function shuffleGrid() {
            // Fisher-Yates shuffle
            for (let i = state.gridItems.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [state.gridItems[i], state.gridItems[j]] = [state.gridItems[j], state.gridItems[i]];
            }
            // Recalculate selected indices based on IDs (to keep selection during shuffle)
            // Ideally we just clear selection on shuffle to avoid complexity/bugs
            state.selectedIndices = []; 
            updateSubmitBtn();
            renderGrid();
        }

        // --- INTERACTION ---

        function handleTileClick(idx) {
            if (state.isGameOver) return;

            const selectedIdxPosition = state.selectedIndices.indexOf(idx);

            if (selectedIdxPosition > -1) {
                // Deselect
                state.selectedIndices.splice(selectedIdxPosition, 1);
            } else {
                // Select (Max 4)
                if (state.selectedIndices.length < 4) {
                    state.selectedIndices.push(idx);
                }
            }
            
            // Optimistic UI Update (faster than full re-render)
            const tiles = DOM.grid.children;
            Array.from(tiles).forEach((t, i) => {
                t.classList.toggle('selected', state.selectedIndices.includes(i));
            });
            
            updateSubmitBtn();
        }

        function updateSubmitBtn() {
            const isReady = state.selectedIndices.length === 4;
            DOM.submitBtn.disabled = !isReady;
            DOM.submitBtn.classList.toggle('ready', isReady);
        }

        function deselectAll() {
            state.selectedIndices = [];
            Array.from(DOM.grid.children).forEach(t => t.classList.remove('selected'));
            updateSubmitBtn();
        }

        function updateLivesUI() {
            DOM.hearts.forEach((h, i) => {
                if (i < state.lives) {
                    h.classList.remove('lost');
                    h.classList.add('active');
                } else {
                    h.classList.add('lost');
                    h.classList.remove('active');
                }
            });
        }

        // --- GAME LOGIC ---

        function handleSubmit() {
            if (state.selectedIndices.length !== 4) return;

            const selectedItems = state.selectedIndices.map(i => state.gridItems[i]);
            const firstGroup = selectedItems[0].group;
            
            // Check if all belong to same group
            const isMatch = selectedItems.every(item => item.group === firstGroup);

            if (isMatch) {
                handleSuccess(firstGroup);
            } else {
                handleMistake(selectedItems);
            }
        }

        function handleSuccess(group) {
            // Remove items from grid
            state.gridItems = state.gridItems.filter(item => item.group !== group);
            state.selectedIndices = [];
            state.solvedGroups.push(group);

            renderGrid();
            createSolvedRow(group);
            updateSubmitBtn();

            if (state.gridItems.length === 0) {
                setTimeout(showWinModal, 1000);
            }
        }

        function createSolvedRow(group) {
            const row = document.createElement('div');
            row.className = 'solved-row';
            row.style.background = group.color;
            row.innerHTML = `
                <div class="solved-category">${group.category}</div>
                <div class="solved-words">${group.items.join(', ')}</div>
                <div class="teacher-note">
                    <span class="note-title">Teacher Note</span>
                    <span class="note-text">${group.note}</span>
                </div>
            `;
            
            // Toggle note logic
            row.onclick = () => {
                row.classList.toggle('open');
            };

            DOM.solvedStack.appendChild(row);
        }

        function handleMistake(selectedItems) {
            state.lives--;
            updateLivesUI();

            // Check "One Away"
            const counts = {};
            selectedItems.forEach(item => {
                const cat = item.group.category;
                counts[cat] = (counts[cat] || 0) + 1;
            });
            const isOneAway = Object.values(counts).includes(3);

            // Shake Animation
            const tiles = DOM.grid.children;
            state.selectedIndices.forEach(i => tiles[i].classList.add('shake'));
            setTimeout(() => {
                Array.from(tiles).forEach(t => t.classList.remove('shake'));
            }, 500);

            if (isOneAway) {
                showToast("One away!", "warn");
            } else {
                showToast("Not quite...", "normal");
            }

            if (state.lives === 0) {
                state.isGameOver = true;
                setTimeout(showLoseModal, 1000);
            }
        }

        function showToast(msg, type) {
            DOM.toastText.innerText = msg;
            DOM.toast.className = `toast visible ${type}`;
            setTimeout(() => DOM.toast.classList.remove('visible'), 2000);
        }

        // --- MODALS & END GAME ---

        function showWinModal() {
            triggerConfetti();
            DOM.modalTitle.innerText = "Splendid!";
            DOM.modalMsg.innerText = "You have cleared the board!";
            DOM.modalActions.innerHTML = `
                <button class="modal-btn btn-primary" onclick="init()">Play Again</button>
            `;
            DOM.modal.style.display = 'flex';
        }

        function showLoseModal() {
            DOM.modalTitle.innerText = "Out of Lives";
            DOM.modalMsg.innerText = "Would you like to try again or see the answers?";
            DOM.modalActions.innerHTML = `
                <button class="modal-btn btn-primary" onclick="loadGame(${state.gameIndex})">Try Again</button>
                <button class="modal-btn btn-secondary" onclick="revealAnswers()">Reveal Answers</button>
            `;
            DOM.modal.style.display = 'flex';
        }

        function revealAnswers() {
            DOM.modal.style.display = 'none';
            DOM.grid.innerHTML = ''; // Clear leftover tiles
            
            // Find unsolved groups
            const allGroups = GAMES[state.gameIndex].groups;
            const unsolved = allGroups.filter(g => !state.solvedGroups.includes(g));

            unsolved.forEach(g => createSolvedRow(g));
        }

        // --- CONFETTI EFFECT ---
        function triggerConfetti() {
            const canvas = DOM.confetti;
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;

            const particles = [];
            const colors = ['#f59e0b', '#10b981', '#0ea5e9', '#8b5cf6'];

            for(let i=0; i<150; i++) {
                particles.push({
                    x: canvas.width/2, y: canvas.height/2,
                    vx: (Math.random()-0.5)*20, vy: (Math.random()-0.5)*20,
                    size: Math.random()*8+4, color: colors[Math.floor(Math.random()*colors.length)],
                    life: 100
                });
            }

            function animate() {
                ctx.clearRect(0,0,canvas.width,canvas.height);
                let active = false;
                particles.forEach(p => {
                    if(p.life > 0) {
                        p.x += p.vx; p.y += p.vy; p.vy += 0.5; p.life--;
                        ctx.fillStyle = p.color; ctx.fillRect(p.x, p.y, p.size, p.size);
                        active = true;
                    }
                });
                if(active) requestAnimationFrame(animate);
                else ctx.clearRect(0,0,canvas.width,canvas.height);
            }
            animate();
        }

        // Start
        init();

    </script>
</body>
</html>
