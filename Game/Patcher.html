<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Balance Patcher v2.4 | PRA Studios</title>
    
    <!-- React Core -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX compilation in browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Framer Motion for Animations -->
    <script src="https://unpkg.com/framer-motion@10.16.4/dist/framer-motion.js"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700;800&family=Permanent+Marker&family=Rock+Salt&display=swap" rel="stylesheet">

    <!-- Custom Styles & Tailwind Config -->
    <style>
        /* Base Reset & Fonts */
        body {
            font-family: 'JetBrains Mono', monospace;
            background-color: #050505;
            color: #e0e0e0;
            overflow-x: hidden; /* Prevent horizontal scroll */
        }
        
        .font-marker { font-family: 'Permanent Marker', cursive; }
        .font-signature { font-family: 'Rock Salt', cursive; }

        /* CRT Effects - Refined for subtlety */
        .scanlines {
            background: linear-gradient(
                to bottom,
                rgba(255,255,255,0),
                rgba(255,255,255,0) 50%,
                rgba(0,0,0,0.1) 50%,
                rgba(0,0,0,0.1)
            );
            background-size: 100% 4px;
            animation: scanlineMove 10s linear infinite;
            pointer-events: none;
            position: fixed;
            inset: 0;
            z-index: 50;
        }

        @keyframes scanlineMove {
            0% { background-position: 0 0; }
            100% { background-position: 0 100%; }
        }

        .crt-flicker {
            animation: flicker 0.15s infinite;
        }

        @keyframes flicker {
            0% { opacity: 0.97; }
            50% { opacity: 1.0; }
            100% { opacity: 0.98; }
        }

        /* Utility */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Input Remove Spinners */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
    </style>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        pra: {
                            bg: '#121212',
                            panel: '#1e1e1e',
                            cyan: '#22d3ee',
                            magenta: '#f472b6',
                            yellow: '#fef08a',
                            green: '#4ade80',
                            dim: '#475569',
                            danger: '#ef4444'
                        }
                    },
                    boxShadow: {
                        'neon-cyan': '0 0 10px rgba(34, 211, 238, 0.3)',
                        'neon-green': '0 0 10px rgba(74, 222, 128, 0.3)',
                        'neon-red': '0 0 10px rgba(244, 114, 182, 0.3)',
                    },
                    animation: {
                        'pulse-fast': 'pulse 1s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-pra-bg text-slate-200 min-h-screen">
    <div id="root"></div>

    <script type="text/babel">
        /**
         * BALANCE PATCHER v2.4
         * Updated: Added Unpaid Intern Level, adjusted difficulty curve, coffee logic
         */

        const { useState, useEffect, useRef, useMemo, useCallback } = React;
        const { motion, AnimatePresence } = window.Motion;

        // --- ICONS & ASSETS ---
        const Icons = {
            Sword: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="14.5 17.5 3 6 3 3 6 3 17.5 14.5"/><line x1="13" y1="19" x2="19" y2="13"/><line x1="16" y1="16" x2="20" y2="20"/><line x1="19" y1="21" x2="21" y2="19"/></svg>,
            Shield: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>,
            Potion: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 22H5c-1.1 0-2-.9-2-2V9a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v11c0 1.1-.9 2-2 2z"/><line x1="12" y1="2" x2="12" y2="7"/><path d="M8 2h8"/></svg>,
            Boots: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4 19a2 2 0 1 0 4 0a2 2 0 0 1 4 0a2 2 0 0 1 4 0a2 2 0 1 0 4 0"/><path d="M5 11h14"/><path d="M5 11a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v8"/></svg>,
            Check: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"/></svg>,
        };

        const getItemIcon = (name) => {
            if (/Sword|Dagger|Blade|Rifle|Bow|Wand|Staff/i.test(name)) return <Icons.Sword />;
            if (/Shield|Guard|Vest|Helm|Greaves|Scale/i.test(name)) return <Icons.Shield />;
            if (/Potion|Soda|Tonic|Elixir|Feather/i.test(name)) return <Icons.Potion />;
            return <Icons.Boots />;
        };

        // Loot Tables based on Rank
        const TIER_1_ITEMS = ["Rusty Dagger", "Canvas Tunic", "Wooden Shield", "Worn Boots", "Cracked Helm", "Old Glove"];
        const TIER_2_ITEMS = ["Potion of Haste", "Mana Ring", "Iron Sword", "Chainmail Vest", "Leather Boots", "Steel Helm"];
        const TIER_3_ITEMS = ["Phoenix Feather", "Void Staff", "Dragon Scale", "Quantum Blade", "Cyber Implant", "Neon Shield"];

        // --- GAME LOGIC ENGINE ---
        
        const generateLevelBatch = (level) => {
            const items = [];
            const tasks = [];
            
            // Item Naming Pool based on Level
            let namePool;
            // Level 1 and 2 share the "starter" items now
            if (level <= 2) namePool = TIER_1_ITEMS;
            else if (level === 3) namePool = TIER_2_ITEMS;
            else namePool = TIER_3_ITEMS;

            // --- UNIQUE ITEMS FIX ---
            // Shuffle the name pool and slice the first 4 to ensure unique names for this batch
            const shuffledNames = [...namePool]
                .sort(() => 0.5 - Math.random())
                .slice(0, 4);

            const brokenIndices = new Set();
            // Ensure exactly 2 items are broken per batch for consistency
            while(brokenIndices.size < 2) brokenIndices.add(Math.floor(Math.random() * 4));

            for (let i = 0; i < 4; i++) {
                const name = shuffledNames[i]; // Use our unique list
                const needsPatch = brokenIndices.has(i);
                
                let base, expected, percent, isBuff;

                // MATH DIFFICULTY CURVE (UPDATED)
                if (level === 1) {
                    // NEW Level 1: Unpaid Intern - 10% or 50% only
                    percent = [10, 50][Math.floor(Math.random() * 2)];
                    base = Math.floor(Math.random() * 10 + 1) * 10; // 10, 20... 100
                }
                else if (level === 2) {
                    // Old Level 1 (Intern) - Multiples of 10%
                    percent = [10, 20, 30, 40, 50][Math.floor(Math.random() * 5)];
                    base = Math.floor(Math.random() * 10 + 1) * 10; // 10, 20... 100
                } 
                else if (level === 3) {
                    // Old Level 2 (Junior) - 5% and 25%
                    percent = [5, 25, 75][Math.floor(Math.random() * 3)];
                    base = Math.floor(Math.random() * 10 + 2) * 20; // 40, 60... 240
                } 
                else {
                    // Old Level 3+ (Senior) - Chaos
                    percent = (Math.floor(Math.random() * 10) + 1) * 5; // 5, 10... 50
                    base = Math.floor(Math.random() * 20 + 5) * 10;
                }

                if (needsPatch) {
                    isBuff = Math.random() > 0.5;
                    const multiplier = isBuff ? (1 + percent/100) : (1 - percent/100);
                    
                    // We calculate expected. Since we controlled Base, this should be integer.
                    expected = Math.round(base * multiplier);

                    const action = isBuff ? "Buff" : "Nerf";
                    const shortName = name.split(" ")[1] || name; 
                    tasks.push(`${action} ${shortName} by ${percent}%`);
                } else {
                    // Stable items just stay at base
                    expected = base;
                }

                items.push({
                    id: Math.random().toString(36).substr(2, 9),
                    name,
                    base,
                    needsPatch,
                    expected,
                    solved: !needsPatch, 
                    isStable: !needsPatch 
                });
            }

            return { items, tasks };
        };

        // --- COMPONENTS ---

        const StartScreen = ({ onStart }) => (
            <div className="flex flex-col items-center justify-center min-h-screen bg-[#1a1a1a] p-6 relative overflow-hidden">
                <div className="absolute inset-0 opacity-10" 
                     style={{backgroundImage: 'radial-gradient(#ffffff 1px, transparent 1px)', backgroundSize: '24px 24px'}}>
                </div>
                
                <motion.div 
                    initial={{ scale: 0.9, opacity: 0, y: 20 }}
                    animate={{ scale: 1, opacity: 1, y: 0 }}
                    transition={{ duration: 0.6, type: "spring" }}
                    className="bg-[#fef9c3] max-w-md w-full p-8 shadow-2xl relative rotate-1"
                >
                    {/* Tape Visual */}
                    <div className="absolute -top-4 left-1/2 -translate-x-1/2 w-32 h-8 bg-white/40 backdrop-blur-sm shadow-sm rotate-2"></div>

                    <div className="font-marker text-slate-900">
                        <div className="border-b-4 border-slate-900 pb-4 mb-6">
                            <h1 className="text-4xl md:text-5xl font-black tracking-tighter mb-2">PRA STUDIOS</h1>
                            <div className="flex justify-between items-center">
                                <span className="text-lg font-bold uppercase">INTERNAL MEMO</span>
                                <span className="text-xs font-sans font-bold bg-red-600 text-white px-2 py-1 rotate-2 rounded-sm shadow-sm">READ ASAP</span>
                            </div>
                        </div>

                        <div className="space-y-4 text-base md:text-lg leading-snug font-sans text-slate-800 font-medium">
                            <p>To: <span className="bg-yellow-400 px-1 font-bold">Unpaid Intern</span></p>
                            <p>The AI model collapsed again. It's pushing garbage stats to production.</p>
                            <p>Manually patch the <span className="font-bold underline text-red-700">broken items</span>. And grab me a double shot espresso while you're at it.</p>
                            <p className="bg-red-100 p-2 border-l-4 border-red-600 text-sm font-bold mt-2">
                                WARNING: Strict launch window. If timer hits zero, overtime fines come out of YOUR non-existent paycheck.
                            </p>
                        </div>

                        <div className="mt-8 flex justify-between items-end">
                            <div>
                                <div className="font-signature text-2xl -rotate-6 text-blue-900 opacity-90">Bowen</div>
                                <p className="text-[10px] font-sans text-slate-500 uppercase tracking-widest mt-1">Lead Architect</p>
                            </div>

                            <button 
                                onClick={onStart}
                                className="font-sans font-bold bg-slate-900 text-white px-6 py-3 hover:bg-pra-cyan hover:text-black hover:-translate-y-1 transition-all shadow-lg active:translate-y-0"
                            >
                                [ ACCEPT TICKET ]
                            </button>
                        </div>
                    </div>
                </motion.div>
            </div>
        );

        const StickyNote = ({ tasks, level, rank }) => {
            const getFlavorText = () => {
                if (level === 1) return "Welcome, unpaid intern. 50% or 10%. Don't spill the coffee.";
                if (level === 2) return "Okay, you haven't crashed it. Here's the regular intern work.";
                if (level === 3) return "Junior Dev just quit. You're up. My coffee is cold.";
                if (level >= 4) return "Senior Dev work. Chaos mode. Need more caffeine.";
                return "Just fix them.";
            };

            const getRankTitle = () => {
                if(level === 1) return "UNPAID_TRIAL";
                if(level === 2) return "INTERN_SPRINT";
                if(level === 3) return "JUNIOR_SPRINT";
                return "SENIOR_SPRINT";
            }

            return (
                <motion.div 
                    initial={{ rotate: -1, y: 10, opacity: 0 }}
                    animate={{ rotate: -1, y: 0, opacity: 1 }}
                    className="bg-[#fef08a] text-slate-900 p-5 shadow-lg transform -rotate-1 flex flex-col h-full min-h-[250px] relative"
                >
                    {/* Tape */}
                    <div className="absolute -top-3 left-1/2 -translate-x-1/2 w-24 h-8 bg-white/30 backdrop-blur-md shadow-sm rotate-1"></div>
                    
                    <div className="font-marker flex-1">
                        <div className="flex justify-between items-baseline border-b-2 border-slate-900/20 pb-2 mb-3">
                            <h2 className="text-xl font-bold">{getRankTitle()}</h2>
                            <span className="text-xs font-sans font-bold opacity-60">TICKET #{level}42</span>
                        </div>
                        
                        <p className="text-xs font-bold font-sans text-slate-600 mb-4 border-l-2 border-slate-900/50 pl-2 italic">
                            "{getFlavorText()}"
                        </p>
                        
                        <ul className="space-y-3 pl-1">
                            {tasks.map((task, i) => (
                                <li key={i} className="text-base md:text-lg font-bold flex items-start gap-2 leading-tight">
                                    <span className="opacity-40 mt-1 scale-75">‚òê</span> 
                                    <span>{task}</span>
                                </li>
                            ))}
                        </ul>
                    </div>

                    <div className="mt-4 pt-2 border-t border-slate-900/10 text-right">
                        <span className="font-signature text-lg text-blue-900/80">- B.</span>
                    </div>
                </motion.div>
            );
        };

        const HUD = ({ rank, level, time, money, goal }) => {
            const progress = Math.min((money/goal) * 100, 100);
            const isOvertime = time <= 0;
            
            return (
                <div className="grid grid-cols-2 md:grid-cols-3 gap-4 mb-6 bg-pra-panel p-4 rounded border border-pra-dim/30 backdrop-blur-sm relative overflow-hidden">
                    
                    {/* Overtime Alarm Overlay */}
                    {isOvertime && (
                        <div className="absolute inset-0 border-2 border-pra-danger pointer-events-none animate-pulse opacity-50 z-0"></div>
                    )}

                    {/* Identity */}
                    <div className="col-span-2 md:col-span-1 flex flex-col justify-center z-10">
                        <h1 className="text-lg md:text-xl font-bold tracking-tighter text-white">
                            PRA<span className="text-pra-cyan">_STUDIOS</span>
                        </h1>
                        <div className="flex items-center gap-2 text-xs text-pra-dim mt-1 font-bold">
                            <span className="bg-slate-800 px-2 py-0.5 rounded text-slate-300 border border-slate-700">{rank}</span>
                            <span>:: SPRINT {level}</span>
                        </div>
                    </div>

                    {/* Timer */}
                    <div className="col-span-1 md:col-span-1 flex flex-col items-start md:items-center justify-center z-10">
                        <div className="text-[10px] text-pra-dim uppercase tracking-widest mb-1">Launch Window</div>
                        <div className={`text-4xl font-black tracking-widest ${time <= 10 ? 'text-pra-danger animate-pulse' : 'text-white'}`}>
                            {time.toString().padStart(2, '0')}s
                        </div>
                        {isOvertime && (
                            <div className="text-[10px] font-bold text-pra-danger animate-bounce bg-pra-danger/10 px-2 py-1 rounded mt-1">
                                ! PENALTY APPLIED !
                            </div>
                        )}
                    </div>

                    {/* Money/Score */}
                    <div className="col-span-1 md:col-span-1 flex flex-col justify-center items-end z-10">
                        <div className="text-[10px] text-pra-dim uppercase tracking-widest mb-1">Project Budget</div>
                        <div className="flex items-baseline gap-2">
                            <span className={`text-2xl font-bold transition-colors duration-300 ${isOvertime ? 'text-pra-danger' : (money < 0 ? 'text-pra-magenta' : 'text-pra-green')}`}>
                                ${money}
                            </span>
                            <span className="text-sm text-slate-600">/ ${goal}</span>
                        </div>
                        {/* Progress Bar */}
                        <div className="w-full max-w-[120px] h-1.5 bg-slate-800 mt-2 rounded-full overflow-hidden">
                            <div 
                                className={`h-full transition-all duration-500 ease-out ${isOvertime ? 'bg-pra-danger' : 'bg-pra-green'}`} 
                                style={{ width: `${progress}%` }}
                            ></div>
                        </div>
                    </div>
                </div>
            );
        };

        const TerminalCard = React.forwardRef(({ item, onSolve }, ref) => {
            const [val, setVal] = useState("");
            const [status, setStatus] = useState("idle"); 
            const inputRef = useRef(null);

            const handleChange = (e) => {
                const v = e.target.value;
                if (v === '' || /^-?\d*$/.test(v)) {
                    setVal(v);
                    
                    // --- AUTO SUBMIT LOGIC ---
                    // Instant success if value matches expected on a broken item
                    const num = parseInt(v, 10);
                    if (!isNaN(num) && !item.isStable && num === item.expected) {
                        setStatus("success");
                        onSolve(item.id, true);
                        if (inputRef.current) inputRef.current.blur();
                    }
                }
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                
                if (item.isStable) {
                    triggerError();
                    return;
                }

                const num = parseInt(val, 10);

                if (!isNaN(num) && num === item.expected) {
                    setStatus("success");
                    onSolve(item.id, true);
                    if (inputRef.current) inputRef.current.blur();
                } else {
                    triggerError();
                }
            };

            const triggerError = () => {
                setStatus("error");
                onSolve(item.id, false);
                setVal("");
                setTimeout(() => setStatus("idle"), 600);
                if (inputRef.current) inputRef.current.focus();
            };

            if (status === "success" || (item.solved && !item.isStable)) {
                return (
                    <motion.div 
                        layout
                        ref={ref}
                        initial={{ opacity: 0, scale: 0.8 }}
                        animate={{ opacity: 1, scale: 1 }}
                        exit={{ opacity: 0, scale: 0.8 }}
                        className="bg-pra-green/10 border border-pra-green p-4 rounded flex flex-col items-center justify-center min-h-[140px] relative overflow-hidden"
                    >
                        <div className="text-pra-green mb-2"><Icons.Check /></div>
                        <div className="text-white font-bold mb-1 text-sm">{item.name}</div>
                        <div className="text-2xl font-bold text-pra-green shadow-neon-green">{item.expected}</div>
                        <div className="text-[10px] text-pra-green tracking-widest mt-1 uppercase font-bold">PATCH COMMITTED</div>
                    </motion.div>
                );
            }

            return (
                <motion.div 
                    layout
                    ref={ref}
                    initial={{ opacity: 0, scale: 0.8 }}
                    animate={status === 'error' ? { x: [-5, 5, -5, 5, 0], opacity: 1, scale: 1 } : { opacity: 1, scale: 1 }}
                    exit={{ opacity: 0, scale: 0.8 }}
                    transition={{ duration: 0.4 }}
                    className={`
                        border-2 p-4 rounded flex flex-col relative min-h-[140px] transition-colors duration-300
                        ${status === 'error' 
                            ? 'bg-pra-magenta/10 border-pra-magenta shadow-neon-red' 
                            : 'bg-black/40 border-slate-700 hover:border-pra-cyan hover:bg-slate-900'}
                    `}
                >
                    <div className="flex items-center gap-3 mb-4">
                        <div className={`p-2 rounded ${status === 'error' ? 'text-pra-magenta bg-pra-magenta/10' : 'text-pra-cyan bg-pra-cyan/10'}`}>
                            {getItemIcon(item.name)}
                        </div>
                        <div className="overflow-hidden">
                            <div className="font-bold text-slate-200 text-sm truncate">{item.name}</div>
                            <div className="text-xs text-slate-500 font-bold mt-0.5">BASE VAL: <span className="text-white text-base">{item.base}</span></div>
                        </div>
                    </div>

                    <form onSubmit={handleSubmit} className="mt-auto w-full">
                        <div className="flex gap-2">
                            <input
                                ref={inputRef}
                                type="text"
                                inputMode="numeric"
                                pattern="[0-9]*"
                                value={val}
                                onChange={handleChange}
                                className={`
                                    flex-1 bg-black border text-lg p-2 rounded focus:outline-none focus:ring-1 transition-all
                                    placeholder:text-slate-700 font-bold
                                    ${status === 'error' 
                                        ? 'border-pra-magenta text-pra-magenta focus:ring-pra-magenta' 
                                        : 'border-slate-700 text-pra-cyan focus:border-pra-cyan focus:ring-pra-cyan'}
                                `}
                                placeholder={item.isStable ? "STABLE" : "PATCH..."}
                                autoComplete="off"
                            />
                            {/* Retained submit button as a manual override/fallback */}
                            <button 
                                type="submit" 
                                className="bg-slate-800 text-slate-200 px-3 rounded hover:bg-pra-cyan hover:text-black transition-colors font-bold"
                            >
                                &gt;
                            </button>
                        </div>
                    </form>
                </motion.div>
            );
        });

        const App = () => {
            // --- STATE ---
            const [gameState, setGameState] = useState("title"); 
            const [level, setLevel] = useState(1);
            const [money, setMoney] = useState(100);
            const [time, setTime] = useState(80); // More generous time (was 60)
            const [data, setData] = useState(null); 
            
            // Goals adjusted for the new easier Level 1
            const LEVEL_GOALS = { 1: 400, 2: 1000, 3: 1800, 4: 3000, 5: 4500 };
            const goal = LEVEL_GOALS[level] || 99999;

            const rank = useMemo(() => {
                if (money < 400) return "Unpaid Intern";
                if (money < 1000) return "Trial Intern";
                if (money < 1800) return "Junior Dev";
                if (money < 3000) return "Senior Dev";
                return "Lead Arch.";
            }, [money]);

            const allPatched = useMemo(() => {
                if (!data) return false;
                return data.items.filter(i => i.needsPatch).every(i => i.solved);
            }, [data]);

            // --- EFFECTS ---

            useEffect(() => {
                if (gameState !== 'playing') return;
                
                const timer = setInterval(() => {
                    setTime(prev => {
                        if (prev <= 0) return 0;
                        return prev - 1;
                    });
                }, 1000);

                return () => clearInterval(timer);
            }, [gameState]);

            // Money Drain on Timeout - Explicit Overtime Mechanic
            useEffect(() => {
                if (gameState === 'playing' && time <= 0) {
                    const drain = setInterval(() => {
                        // Allow going into negative debt for full "fined" feeling
                        setMoney(m => m - 10);
                    }, 1000);
                    return () => clearInterval(drain);
                }
            }, [time, gameState]);

            const startGame = () => {
                setGameState("playing");
                loadLevel(1);
            };

            const loadLevel = (lvl) => {
                setLevel(lvl);
                setTime(80); // Reset to new generous time
                setData(generateLevelBatch(lvl));
            };

            const handleSolve = (id, isCorrect) => {
                if (isCorrect) {
                    setMoney(m => m + 60); // More generous reward (was 50)
                    setData(prev => ({
                        ...prev,
                        items: prev.items.map(i => i.id === id ? { ...i, solved: true } : i)
                    }));
                } else {
                    setMoney(m => m - 20); // Less harsh penalty (was 25)
                }
            };

            const handleNextLevel = () => {
                if (money >= goal) {
                    loadLevel(level + 1);
                } else {
                    loadLevel(level);
                }
            };

            if (gameState === 'title') {
                return <StartScreen onStart={startGame} />;
            }

            if (!data) return <div className="flex h-screen items-center justify-center text-pra-cyan animate-pulse">CONNECTING TO PROD DB...</div>;

            return (
                <div className="min-h-screen relative p-4 md:p-6 lg:p-8 max-w-7xl mx-auto flex flex-col crt-flicker">
                    
                    <div className="scanlines"></div>

                    <div className="relative z-10">
                        <HUD rank={rank} level={level} time={time} money={money} goal={goal} />
                    </div>

                    <div className="relative z-10 flex flex-col lg:flex-row gap-6 flex-1">
                        
                        <div className="w-full lg:w-1/3 xl:w-1/4 flex-shrink-0">
                            <div className="sticky top-4">
                                <StickyNote tasks={data.tasks} level={level} rank={rank} />
                            </div>
                        </div>

                        <div className="w-full lg:w-2/3 xl:w-3/4 flex flex-col">
                            
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <AnimatePresence mode="popLayout">
                                    {data.items.map(item => (
                                        <TerminalCard key={item.id} item={item} onSolve={handleSolve} />
                                    ))}
                                </AnimatePresence>
                            </div>

                            <div className="mt-8 py-4 border-t border-slate-800 flex justify-center lg:justify-end items-center h-24">
                                {allPatched ? (
                                    <motion.button
                                        initial={{ scale: 0.9, opacity: 0 }}
                                        animate={{ scale: 1, opacity: 1 }}
                                        onClick={handleNextLevel}
                                        className="bg-pra-green text-black font-bold text-lg px-8 py-4 rounded shadow-neon-green hover:bg-white hover:scale-105 transition-all w-full md:w-auto"
                                    >
                                        {money >= goal ? "PUSH TO PROD (NEXT SPRINT)" : "RE-RUN BATCH (QUOTA MISSED)"}
                                    </motion.button>
                                ) : (
                                    <div className="text-pra-dim font-bold animate-pulse flex items-center gap-2">
                                        <div className="w-2 h-2 bg-pra-dim rounded-full"></div>
                                        AWAITING FIXES...
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
