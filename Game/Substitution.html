<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Substitution Mastery: Refactored</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;800&family=Plus+Jakarta+Sans:wght@500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        :root {
            /* --- THEME: NEBULA --- */
            --bg-deep: #020617;
            --glass-panel: rgba(15, 23, 42, 0.85);
            --glass-border: rgba(255, 255, 255, 0.1);
            
            /* Variable Colors */
            --var-x: #22d3ee; /* Cyan */
            --var-y: #f472b6; /* Pink */
            --var-z: #4ade80; /* Green */
            --var-other: #fbbf24; /* Amber */

            /* UI Colors */
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --accent-success: #34d399;
            --accent-danger: #ef4444;
            
            --sidebar-width: 260px;
        }

        /* --- RESET & BASE --- */
        * { box-sizing: border-box; margin: 0; padding: 0; user-select: none; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--bg-deep);
            background: radial-gradient(circle at top right, #312e81 0%, #0f172a 60%, #020617 100%);
            color: var(--text-primary);
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            display: flex;
        }

        /* --- LAYOUT --- */
        .app-container {
            display: flex;
            width: 100%;
            height: 100%;
            max-width: 1600px;
            margin: 0 auto;
        }

        /* --- SIDEBAR --- */
        .sidebar {
            width: var(--sidebar-width);
            background: rgba(2, 6, 23, 0.5);
            backdrop-filter: blur(20px);
            border-right: 1px solid var(--glass-border);
            display: flex;
            flex-direction: column;
            padding: 1.5rem;
            z-index: 10;
        }

        .brand {
            font-family: 'Outfit', sans-serif;
            font-weight: 800;
            font-size: 1.4rem;
            margin-bottom: 2rem;
            letter-spacing: -0.5px;
            background: linear-gradient(to right, #fff, #94a3b8);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .level-nav {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .level-btn {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: 12px;
            background: transparent;
            border: 1px solid transparent;
            color: var(--text-secondary);
            font-family: 'Outfit', sans-serif;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: left;
        }

        .level-btn.active {
            background: rgba(34, 211, 238, 0.1);
            border-color: rgba(34, 211, 238, 0.2);
            color: #fff;
        }
        
        .level-btn.locked {
            opacity: 0.4;
            cursor: not-allowed;
            filter: grayscale(1);
        }

        /* --- GAME ARENA --- */
        .arena {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 2rem;
            position: relative;
            overflow-y: auto;
        }

        .header-bar {
            width: 100%;
            max-width: 700px;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin-bottom: 20px;
        }

        .level-title h2 { font-family: 'Outfit'; font-weight: 800; font-size: 2rem; line-height: 1; margin-bottom: 5px; }
        .level-subtitle { font-size: 0.9rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1px; font-weight: 700; }

        .streak-pill {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid var(--glass-border);
            padding: 6px 16px;
            border-radius: 50px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* --- MAIN CARD --- */
        .game-card {
            width: 100%;
            max-width: 700px;
            background: var(--glass-panel);
            backdrop-filter: blur(24px);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            padding: 3rem;
            text-align: center;
            box-shadow: 0 20px 50px -10px rgba(0,0,0,0.5);
            transition: transform 0.2s;
            position: relative;
            overflow: hidden;
        }
        
        /* Dynamic Math Text */
        .math-display {
            font-family: 'Outfit', sans-serif;
            font-size: clamp(2rem, 5vw, 3.5rem);
            font-weight: 700;
            margin-bottom: 2rem;
            min-height: 80px;
            display: flex; justify-content: center; align-items: center;
        }
        
        .var-x { color: var(--var-x); text-shadow: 0 0 20px rgba(34, 211, 238, 0.3); }
        .var-y { color: var(--var-y); text-shadow: 0 0 20px rgba(244, 114, 182, 0.3); }
        .var-z { color: var(--var-z); text-shadow: 0 0 20px rgba(74, 222, 128, 0.3); }
        .var-other { color: var(--var-other); }
        .num-highlight { color: #fff; font-weight: 800; }
        
        /* Input Area */
        .input-display {
            background: rgba(0,0,0,0.3);
            border: 2px solid var(--glass-border);
            border-radius: 16px;
            height: 70px; width: 240px;
            margin: 0 auto 2rem;
            display: flex; justify-content: center; align-items: center;
            font-family: 'Outfit', sans-serif; font-size: 2.5rem; font-weight: 700;
            color: #fff;
            transition: all 0.3s ease;
        }
        
        .input-display.success { border-color: var(--accent-success); color: var(--accent-success); box-shadow: 0 0 30px rgba(52, 211, 153, 0.2); }
        .input-display.error { border-color: var(--accent-danger); animation: shake 0.4s ease-in-out; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }

        /* Keypad */
        .keypad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            max-width: 380px;
            margin: 0 auto;
        }
        
        .key {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.05);
            border-radius: 12px;
            height: 60px;
            display: flex; justify-content: center; align-items: center;
            font-family: 'Outfit', sans-serif; font-size: 1.5rem; font-weight: 600;
            color: #e2e8f0; cursor: pointer;
            transition: all 0.1s;
        }
        .key:active { transform: scale(0.95); background: rgba(255,255,255,0.1); }
        .key-submit { grid-column: span 3; background: var(--var-x); color: #0f172a; font-weight: 800; letter-spacing: 1px; text-transform: uppercase; font-size: 1.1rem; }
        .key-submit:hover { background: #67e8f9; box-shadow: 0 0 15px rgba(34, 211, 238, 0.4); }

        /* --- SOLUTION VISUALIZATION --- */
        .solution-area {
            width: 100%;
            max-width: 700px;
            margin-top: 20px;
            display: none;
        }
        .solution-area.active { display: block; animation: slideUp 0.5s ease; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .timeline-container {
            position: relative;
            padding-left: 20px;
        }
        
        /* Vertical Line */
        .timeline-container::before {
            content: ''; position: absolute; left: 0; top: 10px; bottom: 10px; width: 2px;
            background: linear-gradient(to bottom, var(--var-x), transparent);
            border-radius: 2px;
        }

        .step-item {
            display: flex; align-items: baseline; gap: 15px;
            margin-bottom: 12px; opacity: 0; transform: translateX(-10px);
            transition: all 0.4s ease;
        }
        
        .step-item.visible { opacity: 1; transform: translateX(0); }

        .step-badge {
            font-size: 0.7rem; font-weight: 700; letter-spacing: 1px; text-transform: uppercase;
            color: var(--text-secondary); min-width: 100px; text-align: right;
        }
        
        .step-content {
            font-family: 'Outfit'; font-size: 1.4rem; color: #fff; font-weight: 600;
        }

        .next-btn {
            width: 100%; padding: 16px; margin-top: 20px;
            background: var(--accent-success); color: #020617;
            border: none; border-radius: 12px;
            font-family: 'Outfit'; font-weight: 800; font-size: 1.2rem;
            cursor: pointer; text-transform: uppercase;
            display: none; animation: popIn 0.3s ease;
        }
        @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* Confetti Canvas */
        #confetti { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 100; }

        @media (max-width: 800px) {
            .app-container { flex-direction: column; }
            .sidebar { width: 100%; height: auto; flex-direction: row; overflow-x: auto; align-items: center; border-bottom: 1px solid var(--glass-border); border-right: none; padding: 1rem; }
            .brand { display: none; }
            .level-nav { flex-direction: row; }
            .level-btn { white-space: nowrap; padding: 8px 12px; font-size: 0.8rem; }
            .arena { padding: 1rem; }
            .math-display { font-size: 2rem; }
        }
    </style>
</head>
<body>
    <canvas id="confetti"></canvas>

    <div class="app-container">
        <nav class="sidebar">
            <div class="brand">Substitution Mastery</div>
            <div class="level-nav" id="level-nav">
                </div>
        </nav>

        <main class="arena">
            <div class="header-bar">
                <div class="level-title">
                    <h2 id="lvl-name">Novice</h2>
                    <div class="level-subtitle" id="lvl-desc">Direct Swap</div>
                </div>
                <div class="streak-pill">
                    <i class="fa-solid fa-fire" style="color: var(--var-other)"></i>
                    <span id="streak-count" style="font-weight:700">0</span>
                </div>
            </div>

            <div class="game-card" id="game-card">
                <div class="math-display" id="math-problem"></div>
                <div class="input-display" id="user-input"></div>
                
                <div class="keypad" id="keypad">
                    <div class="key" onclick="inputNum('7')">7</div>
                    <div class="key" onclick="inputNum('8')">8</div>
                    <div class="key" onclick="inputNum('9')">9</div>
                    <div class="key" onclick="inputNum('4')">4</div>
                    <div class="key" onclick="inputNum('5')">5</div>
                    <div class="key" onclick="inputNum('6')">6</div>
                    <div class="key" onclick="inputNum('1')">1</div>
                    <div class="key" onclick="inputNum('2')">2</div>
                    <div class="key" onclick="inputNum('3')">3</div>
                    <div class="key" onclick="inputNum('-')">-</div>
                    <div class="key" onclick="inputNum('0')">0</div>
                    <div class="key" onclick="inputAction('BACK')"><i class="fa-solid fa-delete-left"></i></div>
                    <div class="key key-submit" onclick="submitAnswer()">Submit</div>
                </div>

                <div id="feedback-msg" style="margin-top:15px; height:20px; font-weight:600; color:var(--text-secondary)"></div>
            </div>

            <div class="solution-area" id="solution-area">
                <div class="game-card" style="text-align: left; padding: 2rem;">
                    <div class="timeline-container" id="steps-container">
                        </div>
                    <button class="next-btn" id="next-btn" onclick="nextQuestion()">Next Question <i class="fa-solid fa-arrow-right"></i></button>
                </div>
            </div>
        </main>
    </div>

    <script>
        /**
         * REFACTORED DATABASE
         * 80 Standard Questions sorted Easiest -> Hardest (New Levels 1-4)
         * 20 Word Problems moved to Level 5.
         */
        const GAME_DATA = [
            {
                id: 0, name: "Novice", desc: "Positive Integers & Basic Ops",
                problems: [
                    // --- Tier 1: Direct Swap, Single Variable, Positives ---
                    { q: "If x = 3, calculate 2x + 1", a: 7, steps: [{l:"Formula", m:"2x + 1"}, {l:"Sub", m:"2(3) + 1"}, {l:"Calc", m:"6 + 1"}, {l:"Ans", m:"7"}] },
                    { q: "If a = 4, calculate 5a + 3", a: 23, steps: [{l:"Formula", m:"5a + 3"}, {l:"Sub", m:"5(4) + 3"}, {l:"Calc", m:"20 + 3"}, {l:"Ans", m:"23"}] },
                    { q: "If m = 2, calculate 10m + 5", a: 25, steps: [{l:"Formula", m:"10m + 5"}, {l:"Sub", m:"10(2) + 5"}, {l:"Calc", m:"20 + 5"}, {l:"Ans", m:"25"}] },
                    { q: "If x = 5, calculate 3x - 2", a: 13, steps: [{l:"Formula", m:"3x - 2"}, {l:"Sub", m:"3(5) - 2"}, {l:"Calc", m:"15 - 2"}, {l:"Ans", m:"13"}] },
                    { q: "If k = 6, calculate 4k - 1", a: 23, steps: [{l:"Formula", m:"4k - 1"}, {l:"Sub", m:"4(6) - 1"}, {l:"Calc", m:"24 - 1"}, {l:"Ans", m:"23"}] },
                    { q: "If y = 10, calculate 2y - 10", a: 10, steps: [{l:"Formula", m:"2y - 10"}, {l:"Sub", m:"2(10) - 10"}, {l:"Calc", m:"20 - 10"}, {l:"Ans", m:"10"}] },
                    { q: "If x = 0, calculate 5x + 8", a: 8, steps: [{l:"Formula", m:"5x + 8"}, {l:"Sub", m:"5(0) + 8"}, {l:"Calc", m:"0 + 8"}, {l:"Ans", m:"8"}] },
                    { q: "If b = 7, calculate 2b + b", a: 21, steps: [{l:"Formula", m:"2b + b"}, {l:"Sub", m:"2(7) + 7"}, {l:"Calc", m:"14 + 7"}, {l:"Ans", m:"21"}] },
                    { q: "If n = 3, calculate 1 + 4n", a: 13, steps: [{l:"Formula", m:"1 + 4n"}, {l:"Sub", m:"1 + 4(3)"}, {l:"Calc", m:"1 + 12"}, {l:"Ans", m:"13"}] },
                    { q: "If x = 1, calculate 10x - 9", a: 1, steps: [{l:"Formula", m:"10x - 9"}, {l:"Sub", m:"10(1) - 9"}, {l:"Calc", m:"10 - 9"}, {l:"Ans", m:"1"}] },
                    { q: "If p = 5, calculate 20 - 2p", a: 10, steps: [{l:"Formula", m:"20 - 2p"}, {l:"Sub", m:"20 - 2(5)"}, {l:"Calc", m:"20 - 10"}, {l:"Ans", m:"10"}] },
                    { q: "If w = 10, calculate 50 - 3w", a: 20, steps: [{l:"Formula", m:"50 - 3w"}, {l:"Sub", m:"50 - 3(10)"}, {l:"Calc", m:"50 - 30"}, {l:"Ans", m:"20"}] },
                    { q: "If c = 9, calculate 2c - 18", a: 0, steps: [{l:"Formula", m:"2c - 18"}, {l:"Sub", m:"2(9) - 18"}, {l:"Calc", m:"18 - 18"}, {l:"Ans", m:"0"}] },
                    { q: "If x = 5, calculate 100 - 10x", a: 50, steps: [{l:"Formula", m:"100 - 10x"}, {l:"Sub", m:"100 - 10(5)"}, {l:"Calc", m:"100 - 50"}, {l:"Ans", m:"50"}] },
                    { q: "If z = 2, calculate 3z + 4z", a: 14, steps: [{l:"Formula", m:"3z + 4z"}, {l:"Sub", m:"3(2) + 4(2)"}, {l:"Calc", m:"6 + 8"}, {l:"Ans", m:"14"}] },
                    { q: "If x = 8, calculate x/2 + 1", a: 5, steps: [{l:"Formula", m:"x/2 + 1"}, {l:"Sub", m:"8/2 + 1"}, {l:"Calc", m:"4 + 1"}, {l:"Ans", m:"5"}] },
                    { q: "If x = 12, calculate x/4 - 2", a: 1, steps: [{l:"Formula", m:"x/4 - 2"}, {l:"Sub", m:"12/4 - 2"}, {l:"Calc", m:"3 - 2"}, {l:"Ans", m:"1"}] },
                    { q: "If a = 20, calculate a/5 + 6", a: 10, steps: [{l:"Formula", m:"a/5 + 6"}, {l:"Sub", m:"20/5 + 6"}, {l:"Calc", m:"4 + 6"}, {l:"Ans", m:"10"}] },
                    { q: "If y = 4, calculate 10 + y/2", a: 12, steps: [{l:"Formula", m:"10 + y/2"}, {l:"Sub", m:"10 + 4/2"}, {l:"Calc", m:"10 + 2"}, {l:"Ans", m:"12"}] },
                    { q: "If x = 6, calculate x/3 + x", a: 8, steps: [{l:"Formula", m:"x/3 + x"}, {l:"Sub", m:"6/3 + 6"}, {l:"Calc", m:"2 + 6"}, {l:"Ans", m:"8"}] }
                ]
            },
            {
                id: 1, name: "Apprentice", desc: "Negative Numbers",
                problems: [
                    // --- Tier 2: Introducing Negatives ---
                    { q: "If x = -2, calculate x + 5", a: 3, steps: [{l:"Formula", m:"x + 5"}, {l:"Sub", m:"(-2) + 5"}, {l:"Ans", m:"3"}] },
                    { q: "If x = -4, calculate x + 4", a: 0, steps: [{l:"Formula", m:"x + 4"}, {l:"Sub", m:"(-4) + 4"}, {l:"Ans", m:"0"}] },
                    { q: "If y = -3, calculate 10 + y", a: 7, steps: [{l:"Formula", m:"10 + y"}, {l:"Sub", m:"10 + (-3)"}, {l:"Ans", m:"7"}] },
                    { q: "If a = -5, calculate a - 2", a: -7, steps: [{l:"Formula", m:"a - 2"}, {l:"Sub", m:"(-5) - 2"}, {l:"Ans", m:"-7"}] },
                    { q: "If k = -1, calculate k - 9", a: -10, steps: [{l:"Formula", m:"k - 9"}, {l:"Sub", m:"(-1) - 9"}, {l:"Ans", m:"-10"}] },
                    { q: "If x = -3, calculate 2x", a: -6, steps: [{l:"Formula", m:"2x"}, {l:"Sub", m:"2(-3)"}, {l:"Ans", m:"-6"}] },
                    { q: "If x = -5, calculate 3x", a: -15, steps: [{l:"Formula", m:"3x"}, {l:"Sub", m:"3(-5)"}, {l:"Ans", m:"-15"}] },
                    { q: "If m = -10, calculate m/2", a: -5, steps: [{l:"Formula", m:"m/2"}, {l:"Sub", m:"(-10)/2"}, {l:"Ans", m:"-5"}] },
                    { q: "If w = -3, calculate -2w", a: 6, steps: [{l:"Formula", m:"-2w"}, {l:"Sub", m:"-2(-3)"}, {l:"Ans", m:"6"}] },
                    { q: "If k = -5, calculate -4k", a: 20, steps: [{l:"Formula", m:"-4k"}, {l:"Sub", m:"-4(-5)"}, {l:"Ans", m:"20"}] },
                    { q: "If x = -2, calculate 2x + 5", a: 1, steps: [{l:"Formula", m:"2x + 5"}, {l:"Sub", m:"2(-2) + 5"}, {l:"Calc", m:"-4 + 5"}, {l:"Ans", m:"1"}] },
                    { q: "If x = -3, calculate 3x - 1", a: -10, steps: [{l:"Formula", m:"3x - 1"}, {l:"Sub", m:"3(-3) - 1"}, {l:"Calc", m:"-9 - 1"}, {l:"Ans", m:"-10"}] },
                    { q: "If p = -4, calculate 10p", a: -40, steps: [{l:"Formula", m:"10p"}, {l:"Sub", m:"10(-4)"}, {l:"Ans", m:"-40"}] },
                    { q: "If a = -6, calculate a/3 + 2", a: 0, steps: [{l:"Formula", m:"a/3 + 2"}, {l:"Sub", m:"(-6)/3 + 2"}, {l:"Calc", m:"-2 + 2"}, {l:"Ans", m:"0"}] },
                    { q: "If x = -1, calculate 1 - x", a: 2, steps: [{l:"Formula", m:"1 - x"}, {l:"Sub", m:"1 - (-1)"}, {l:"Calc", m:"1 + 1"}, {l:"Ans", m:"2"}] },
                    { q: "If y = -5, calculate 10 - y", a: 15, steps: [{l:"Formula", m:"10 - y"}, {l:"Sub", m:"10 - (-5)"}, {l:"Calc", m:"10 + 5"}, {l:"Ans", m:"15"}] },
                    { q: "If x = -2, calculate 5 - x", a: 7, steps: [{l:"Formula", m:"5 - x"}, {l:"Sub", m:"5 - (-2)"}, {l:"Calc", m:"5 + 2"}, {l:"Ans", m:"7"}] },
                    { q: "If x = -1, calculate 5x + 5", a: 0, steps: [{l:"Formula", m:"5x + 5"}, {l:"Sub", m:"5(-1) + 5"}, {l:"Calc", m:"-5 + 5"}, {l:"Ans", m:"0"}] },
                    { q: "If a = -10, calculate 20 + a", a: 10, steps: [{l:"Formula", m:"20 + a"}, {l:"Sub", m:"20 + (-10)"}, {l:"Ans", m:"10"}] },
                    { q: "If x = -4, calculate 0 - x", a: 4, steps: [{l:"Formula", m:"0 - x"}, {l:"Sub", m:"0 - (-4)"}, {l:"Calc", m:"0 + 4"}, {l:"Ans", m:"4"}] }
                ]
            },
            {
                id: 2, name: "Expert", desc: "Multi-Var & Distribution",
                problems: [
                    // --- Tier 3: Two Vars, Parentheses, Complex Negatives ---
                    { q: "If x = 3 and y = 2, calculate x + y", a: 5, steps: [{l:"Formula", m:"x + y"}, {l:"Sub", m:"3 + 2"}, {l:"Ans", m:"5"}] },
                    { q: "If x = 5 and y = 3, calculate x - y", a: 2, steps: [{l:"Formula", m:"x - y"}, {l:"Sub", m:"5 - 3"}, {l:"Ans", m:"2"}] },
                    { q: "If a = 4 and b = 5, calculate ab", a: 20, steps: [{l:"Formula", m:"ab"}, {l:"Sub", m:"(4)(5)"}, {l:"Ans", m:"20"}] },
                    { q: "If x = 2 and y = -3, calculate xy", a: -6, steps: [{l:"Formula", m:"xy"}, {l:"Sub", m:"(2)(-3)"}, {l:"Ans", m:"-6"}] },
                    { q: "If m = 10, calculate 2(m + 1)", a: 22, steps: [{l:"Formula", m:"2(m + 1)"}, {l:"Sub", m:"2(10 + 1)"}, {l:"Calc", m:"2(11)"}, {l:"Ans", m:"22"}] },
                    { q: "If n = 5, calculate 3(n - 2)", a: 9, steps: [{l:"Formula", m:"3(n - 2)"}, {l:"Sub", m:"3(5 - 2)"}, {l:"Calc", m:"3(3)"}, {l:"Ans", m:"9"}] },
                    { q: "If x = 4, calculate 5(10 - x)", a: 30, steps: [{l:"Formula", m:"5(10 - x)"}, {l:"Sub", m:"5(10 - 4)"}, {l:"Calc", m:"5(6)"}, {l:"Ans", m:"30"}] },
                    { q: "If a = 3, calculate a(a + 2)", a: 15, steps: [{l:"Formula", m:"a(a + 2)"}, {l:"Sub", m:"3(3 + 2)"}, {l:"Calc", m:"3(5)"}, {l:"Ans", m:"15"}] },
                    { q: "If x = 2 and y = 5, calculate 2x + y", a: 9, steps: [{l:"Formula", m:"2x + y"}, {l:"Sub", m:"2(2) + 5"}, {l:"Calc", m:"4 + 5"}, {l:"Ans", m:"9"}] },
                    { q: "If a = 3 and b = 4, calculate 3a - 2b", a: 1, steps: [{l:"Formula", m:"3a - 2b"}, {l:"Sub", m:"3(3) - 2(4)"}, {l:"Calc", m:"9 - 8"}, {l:"Ans", m:"1"}] },
                    { q: "If x = 6, calculate (x + 4)/2", a: 5, steps: [{l:"Formula", m:"(x + 4)/2"}, {l:"Sub", m:"(6 + 4)/2"}, {l:"Calc", m:"10/2"}, {l:"Ans", m:"5"}] },
                    { q: "If x = 10, calculate (20 - x)/5", a: 2, steps: [{l:"Formula", m:"(20 - x)/5"}, {l:"Sub", m:"(20 - 10)/5"}, {l:"Calc", m:"10/5"}, {l:"Ans", m:"2"}] },
                    { q: "If x = -2, calculate 3(x + 5)", a: 9, steps: [{l:"Formula", m:"3(x + 5)"}, {l:"Sub", m:"3(-2 + 5)"}, {l:"Calc", m:"3(3)"}, {l:"Ans", m:"9"}] },
                    { q: "If y = -4, calculate 2(y - 1)", a: -10, steps: [{l:"Formula", m:"2(y - 1)"}, {l:"Sub", m:"2(-4 - 1)"}, {l:"Calc", m:"2(-5)"}, {l:"Ans", m:"-10"}] },
                    { q: "If x = 3 and y = -2, calculate x + 2y", a: -1, steps: [{l:"Formula", m:"x + 2y"}, {l:"Sub", m:"3 + 2(-2)"}, {l:"Calc", m:"3 - 4"}, {l:"Ans", m:"-1"}] },
                    { q: "If a = 5, calculate 2(a + a)", a: 20, steps: [{l:"Formula", m:"2(a + a)"}, {l:"Sub", m:"2(5 + 5)"}, {l:"Calc", m:"2(10)"}, {l:"Ans", m:"20"}] },
                    { q: "If x = -3, calculate x(x + 1)", a: 6, steps: [{l:"Formula", m:"x(x + 1)"}, {l:"Sub", m:"-3(-3 + 1)"}, {l:"Calc", m:"-3(-2)"}, {l:"Ans", m:"6"}] },
                    { q: "If p = 4 and q = 2, calculate p/q", a: 2, steps: [{l:"Formula", m:"p/q"}, {l:"Sub", m:"4/2"}, {l:"Ans", m:"2"}] },
                    { q: "If x = 5, calculate 10(x - 5)", a: 0, steps: [{l:"Formula", m:"10(x - 5)"}, {l:"Sub", m:"10(5 - 5)"}, {l:"Calc", m:"10(0)"}, {l:"Ans", m:"0"}] },
                    { q: "If x = -1 and y = -1, calculate x + y", a: -2, steps: [{l:"Formula", m:"x + y"}, {l:"Sub", m:"(-1) + (-1)"}, {l:"Ans", m:"-2"}] }
                ]
            },
            {
                id: 3, name: "Master", desc: "Exponents & Roots",
                problems: [
                    // --- Tier 4: Exponents (From Old Level 5) ---
                    { q: "If x = 3, calculate x^2", a: 9, steps: [{l:"Formula", m:"x^2"}, {l:"Sub", m:"(3)^2"}, {l:"Ans", m:"9"}] },
                    { q: "If x = 5, calculate x^2 + 1", a: 26, steps: [{l:"Formula", m:"x^2 + 1"}, {l:"Sub", m:"(5)^2 + 1"}, {l:"Calc", m:"25 + 1"}, {l:"Ans", m:"26"}] },
                    { q: "If x = 2, calculate 3x^2", a: 12, steps: [{l:"Formula", m:"3x^2"}, {l:"Sub", m:"3(2)^2"}, {l:"Calc", m:"3(4)"}, {l:"Ans", m:"12"}] },
                    { q: "If x = -2, calculate x^2", a: 4, steps: [{l:"Formula", m:"x^2"}, {l:"Sub", m:"(-2)^2"}, {l:"Ans", m:"4"}] },
                    { q: "If x = -4, calculate x^2", a: 16, steps: [{l:"Formula", m:"x^2"}, {l:"Sub", m:"(-4)^2"}, {l:"Ans", m:"16"}] },
                    { q: "If x = -1, calculate x^2 + 5", a: 6, steps: [{l:"Formula", m:"x^2 + 5"}, {l:"Sub", m:"(-1)^2 + 5"}, {l:"Calc", m:"1 + 5"}, {l:"Ans", m:"6"}] },
                    { q: "If x = -3, calculate 2x^2", a: 18, steps: [{l:"Formula", m:"2x^2"}, {l:"Sub", m:"2(-3)^2"}, {l:"Calc", m:"2(9)"}, {l:"Ans", m:"18"}] },
                    { q: "If x = 4, calculate x^2 - x", a: 12, steps: [{l:"Formula", m:"x^2 - x"}, {l:"Sub", m:"4^2 - 4"}, {l:"Calc", m:"16 - 4"}, {l:"Ans", m:"12"}] },
                    { q: "If x = -2, calculate x^2 + x", a: 2, steps: [{l:"Formula", m:"x^2 + x"}, {l:"Sub", m:"(-2)^2 + (-2)"}, {l:"Calc", m:"4 - 2"}, {l:"Ans", m:"2"}] },
                    { q: "If y = 3, calculate 2y^2 - 10", a: 8, steps: [{l:"Formula", m:"2y^2 - 10"}, {l:"Sub", m:"2(3)^2 - 10"}, {l:"Calc", m:"18 - 10"}, {l:"Ans", m:"8"}] },
                    { q: "If x = 5, calculate sqrt(x + 4)", a: 3, steps: [{l:"Formula", m:"√(x + 4)"}, {l:"Sub", m:"√(5 + 4)"}, {l:"Calc", m:"√9"}, {l:"Ans", m:"3"}] },
                    { q: "If x = 10, calculate sqrt(10x)", a: 10, steps: [{l:"Formula", m:"√(10x)"}, {l:"Sub", m:"√(10·10)"}, {l:"Calc", m:"√100"}, {l:"Ans", m:"10"}] },
                    { q: "If x = -5, calculate 100 - x^2", a: 75, steps: [{l:"Formula", m:"100 - x^2"}, {l:"Sub", m:"100 - (-5)^2"}, {l:"Calc", m:"100 - 25"}, {l:"Ans", m:"75"}] },
                    { q: "If a = 3, calculate a^3", a: 27, steps: [{l:"Formula", m:"a^3"}, {l:"Sub", m:"3^3"}, {l:"Ans", m:"27"}] },
                    { q: "If x = 2, calculate (x + 3)^2", a: 25, steps: [{l:"Formula", m:"(x + 3)^2"}, {l:"Sub", m:"(2 + 3)^2"}, {l:"Calc", m:"5^2"}, {l:"Ans", m:"25"}] },
                    { q: "If x = 3 and y = 4, calculate x^2 + y^2", a: 25, steps: [{l:"Formula", m:"x^2 + y^2"}, {l:"Sub", m:"3^2 + 4^2"}, {l:"Calc", m:"9 + 16"}, {l:"Ans", m:"25"}] },
                    { q: "If x = -2, calculate x^3", a: -8, steps: [{l:"Formula", m:"x^3"}, {l:"Sub", m:"(-2)^3"}, {l:"Ans", m:"-8"}] },
                    { q: "If x = 5, calculate 2(x - 2)^2", a: 18, steps: [{l:"Formula", m:"2(x - 2)^2"}, {l:"Sub", m:"2(5 - 2)^2"}, {l:"Calc", m:"2(3)^2"}, {l:"Ans", m:"18"}] },
                    { q: "If x = -1, calculate 1 - x^2", a: 0, steps: [{l:"Formula", m:"1 - x^2"}, {l:"Sub", m:"1 - (-1)^2"}, {l:"Calc", m:"1 - 1"}, {l:"Ans", m:"0"}] },
                    { q: "If x = 3, calculate 2x^2 + 3x - 5", a: 22, steps: [{l:"Formula", m:"2x^2 + 3x - 5"}, {l:"Sub", m:"2(3)^2 + 3(3) - 5"}, {l:"Calc", m:"18 + 9 - 5"}, {l:"Ans", m:"22"}] }
                ]
            },
            {
                id: 4, name: "Grandmaster", desc: "Word Problems & Formulas",
                problems: [
                    // --- Tier 5: The original Level 4 moved here ---
                    { q: "A rectangle has length l = 12 and width w = 5. Calculate the Perimeter (P = 2(l + w)).", a: 34, steps: [{l:"Formula", m:"P = 2(l + w)"}, {l:"Sub", m:"2(12 + 5)"}, {l:"Calc", m:"2(17)"}, {l:"Ans", m:"34"}] },
                    { q: "A rectangle has length l = 20 and width w = 10. Calculate the Area (A = l × w).", a: 200, steps: [{l:"Formula", m:"A = lw"}, {l:"Sub", m:"(20)(10)"}, {l:"Ans", m:"200"}] },
                    { q: "Mr. Bowen is 34 years old. Mr. Seth is \"5 years older than twice Mr. Bowen's age\". Calculate Mr. Seth's age (2b + 5).", a: 73, steps: [{l:"Formula", m:"2b + 5"}, {l:"Sub", m:"2(34) + 5"}, {l:"Calc", m:"68 + 5"}, {l:"Ans", m:"73"}] },
                    { q: "The profit of a lemonade stand is P = 5n - 20, where n is the number of cups sold. Calculate the profit if n = 10 cups.", a: 30, steps: [{l:"Formula", m:"P = 5n - 20"}, {l:"Sub", m:"5(10) - 20"}, {l:"Calc", m:"50 - 20"}, {l:"Ans", m:"30"}] },
                    { q: "A taxi charges a base fee of 5 dollars plus 2 dollars for every kilometer traveled. If k = 15 km, calculate the total Cost (5 + 2k).", a: 35, steps: [{l:"Formula", m:"5 + 2k"}, {l:"Sub", m:"5 + 2(15)"}, {l:"Calc", m:"5 + 30"}, {l:"Ans", m:"35"}] },
                    { q: "Mr. Bowen is b = 15 years old. Mr. Seth is \"3 times the value of 2 years less than Mr. Bowen\". Calculate Mr. Seth's age (3(b - 2)).", a: 39, steps: [{l:"Formula", m:"3(b - 2)"}, {l:"Sub", m:"3(15 - 2)"}, {l:"Calc", m:"3(13)"}, {l:"Ans", m:"39"}] },
                    { q: "In physics, final velocity is v = u + at. If initial velocity u = 10, acceleration a = 5, and time t = 4, calculate v.", a: 30, steps: [{l:"Formula", m:"v = u + at"}, {l:"Sub", m:"10 + 5(4)"}, {l:"Calc", m:"10 + 20"}, {l:"Ans", m:"30"}] },
                    { q: "A triangle has a base b = 8 and height h = 5. Calculate the Area using the formula A = 1/2bh.", a: 20, steps: [{l:"Formula", m:"A = 0.5bh"}, {l:"Sub", m:"0.5(8)(5)"}, {l:"Calc", m:"4(5)"}, {l:"Ans", m:"20"}] },
                    { q: "Mr. Bowen is b = 20 years old. Mr. Seth is \"the square of (Mr. Bowen minus 14)\". Calculate Mr. Seth's age ((b - 14)^2).", a: 36, steps: [{l:"Formula", m:"(b - 14)^2"}, {l:"Sub", m:"(20 - 14)^2"}, {l:"Calc", m:"(6)^2"}, {l:"Ans", m:"36"}] },
                    { q: "A phone plan costs C = 30 + 2(d - 5) where d is data usage. If you use d = 8 GB, what is the cost?", a: 36, steps: [{l:"Formula", m:"30 + 2(d - 5)"}, {l:"Sub", m:"30 + 2(8 - 5)"}, {l:"Calc", m:"30 + 6"}, {l:"Ans", m:"36"}] },
                    { q: "An object falls from a height. Its height after t seconds is h = 100 - 5t^2. Calculate the height after t = 4 seconds.", a: 20, steps: [{l:"Formula", m:"h = 100 - 5t^2"}, {l:"Sub", m:"100 - 5(4)^2"}, {l:"Calc", m:"100 - 80"}, {l:"Ans", m:"20"}] },
                    { q: "Mr. Bowen is b = 18 years old. Mr. Seth is \"half of Mr. Bowen's age squared, plus 10\". Calculate Mr. Seth's age (b^2/2 + 10).", a: 172, steps: [{l:"Formula", m:"b^2/2 + 10"}, {l:"Sub", m:"18^2/2 + 10"}, {l:"Calc", m:"162 + 10"}, {l:"Ans", m:"172"}] },
                    { q: "You buy x = 3 books costing 12 dollars each and y = 2 pens costing 4 dollars each. The total cost is 12x + 4y. Calculate the total.", a: 44, steps: [{l:"Formula", m:"12x + 4y"}, {l:"Sub", m:"12(3) + 4(2)"}, {l:"Calc", m:"36 + 8"}, {l:"Ans", m:"44"}] },
                    { q: "To convert temperature from Celsius to Fahrenheit, use F = 1.8C + 32. If it is C = 20 degrees, what is the temperature in Fahrenheit?", a: 68, steps: [{l:"Formula", m:"F = 1.8C + 32"}, {l:"Sub", m:"1.8(20) + 32"}, {l:"Calc", m:"36 + 32"}, {l:"Ans", m:"68"}] },
                    { q: "A box has length l=5, width w=4, and height h=3. The Surface Area is SA = 2(lw + lh + wh). Calculate the Surface Area.", a: 94, steps: [{l:"Formula", m:"SA = 2(lw+lh+wh)"}, {l:"Sub", m:"2(20 + 15 + 12)"}, {l:"Calc", m:"2(47)"}, {l:"Ans", m:"94"}] },
                    { q: "Mr. Bowen is b = 50 years old. Mr. Seth is \"100 minus half of Mr. Bowen's age\". Calculate Mr. Seth's age (100 - b/2).", a: 75, steps: [{l:"Formula", m:"100 - b/2"}, {l:"Sub", m:"100 - 50/2"}, {l:"Calc", m:"100 - 25"}, {l:"Ans", m:"75"}] },
                    { q: "Kinetic Energy is calculated by E = 1/2mv^2. If mass m = 10 and velocity v = 6, calculate the Energy.", a: 180, steps: [{l:"Formula", m:"E = 0.5mv^2"}, {l:"Sub", m:"0.5(10)(6)^2"}, {l:"Calc", m:"5(36)"}, {l:"Ans", m:"180"}] },
                    { q: "A number sequence is given by the rule T = n(n + 1). Calculate the 10th term (where n = 10).", a: 110, steps: [{l:"Formula", m:"T = n(n + 1)"}, {l:"Sub", m:"10(10 + 1)"}, {l:"Calc", m:"10(11)"}, {l:"Ans", m:"110"}] },
                    { q: "Mr. Bowen is b = 16 years old. Mr. Seth is \"3 times the square root of Mr. Bowen, plus 40\". Calculate Mr. Seth's age (3√b + 40).", a: 52, steps: [{l:"Formula", m:"3√b + 40"}, {l:"Sub", m:"3√16 + 40"}, {l:"Calc", m:"12 + 40"}, {l:"Ans", m:"52"}] },
                    { q: "Challenge: The volume of a cone is V = 1/3 pi r^2 h. If we approximate pi = 3, radius r = 4, and height h = 5, calculate V.", a: 80, steps: [{l:"Formula", m:"V = 1/3(3)r^2h"}, {l:"Sub", m:"1(4)^2(5)"}, {l:"Calc", m:"16(5)"}, {l:"Ans", m:"80"}] }
                ]
            }
        ];

        /* --- STATE MANAGEMENT --- */
        let state = {
            currentLevel: 0,
            maxLevel: 0,
            streak: 0,
            currentProblemIndex: 0,
            problemQueue: [],
            currentInput: "",
            isProcessing: false, // Prevents spamming
            isSolved: false
        };

        // --- INIT ---
        window.onload = () => {
            initLevel(0);
            renderSidebar();
            
            // Keyboard Hooks
            document.addEventListener('keydown', (e) => {
                if(state.isProcessing || state.isSolved) {
                    if(e.key === 'Enter') nextQuestion();
                    return;
                }
                
                if(/[0-9]/.test(e.key)) inputNum(e.key);
                if(e.key === '-') inputNum('-');
                if(e.key === 'Backspace') inputAction('BACK');
                if(e.key === 'Enter') submitAnswer();
            });
        };

        function renderSidebar() {
            const nav = document.getElementById('level-nav');
            nav.innerHTML = '';
            
            GAME_DATA.forEach((lvl, idx) => {
                const btn = document.createElement('button');
                const isLocked = idx > state.maxLevel;
                const isActive = idx === state.currentLevel;
                
                btn.className = `level-btn ${isActive ? 'active' : ''} ${isLocked ? 'locked' : ''}`;
                
                let icon = 'fa-star';
                if(idx===1) icon = 'fa-bolt';
                if(idx===2) icon = 'fa-brain';
                if(idx===3) icon = 'fa-cube';
                if(idx===4) icon = 'fa-crown';

                btn.innerHTML = `<i class="fa-solid ${isLocked ? 'fa-lock' : icon}"></i> <span>${lvl.name}</span>`;
                
                if(!isLocked) {
                    btn.onclick = () => {
                        if(state.isProcessing) return;
                        initLevel(idx);
                        renderSidebar();
                    };
                }
                nav.appendChild(btn);
            });
        }

        function initLevel(lvlIdx) {
            state.currentLevel = lvlIdx;
            state.streak = 0;
            state.problemQueue = [...GAME_DATA[lvlIdx].problems].sort(() => Math.random() - 0.5);
            
            const levelData = GAME_DATA[lvlIdx];
            document.getElementById('lvl-name').innerText = levelData.name;
            document.getElementById('lvl-desc').innerText = levelData.desc;
            document.getElementById('streak-count').innerText = 0;
            
            loadNextProblem();
        }

        function loadNextProblem() {
            if(state.problemQueue.length === 0) {
                // Check for level up
                if(state.streak >= 5 && state.currentLevel < 4) {
                    state.maxLevel = Math.max(state.maxLevel, state.currentLevel + 1);
                    confettiBurst();
                    setTimeout(() => {
                        alert(`Level Complete! Unlocking ${GAME_DATA[state.currentLevel+1].name}`);
                        initLevel(state.currentLevel + 1);
                        renderSidebar();
                    }, 1000);
                    return;
                }
                // Reshuffle if not leveling up
                state.problemQueue = [...GAME_DATA[state.currentLevel].problems].sort(() => Math.random() - 0.5);
            }

            state.currentProblem = state.problemQueue.pop();
            state.currentInput = "";
            state.isSolved = false;
            state.isProcessing = false;

            // UI Reset
            document.getElementById('math-problem').innerHTML = formatMathExpression(state.currentProblem.q);
            
            const inp = document.getElementById('user-input');
            inp.innerText = "";
            inp.className = 'input-display'; // Remove success/error classes
            
            document.getElementById('solution-area').classList.remove('active');
            document.getElementById('keypad').style.display = 'grid';
            document.getElementById('feedback-msg').innerText = "";
            document.getElementById('next-btn').style.display = 'none';
        }

        /**
         * ENGINE: Variable Coloring
         * Parses string, finds variables, wraps them in colored spans.
         */
        function formatMathExpression(str) {
            // 1. Handle Exponents (x^2 -> x<sup>2</sup>)
            let formatted = str.replace(/\^(\d+)/g, '<sup>$1</sup>');
            
            // 2. Handle Square Root (sqrt(x) -> √x)
            formatted = formatted.replace(/sqrt\(([^)]+)\)/g, '√$1');

            // 3. Variable Coloring
            // Regex matches single letters surrounded by non-letters (word boundaries)
            // But ignores common words like "If", "calculate", "and"
            const blacklist = ['If', 'if', 'and', 'calculate', 'Calculate', 'the', 'is', 'a', 'A']; // 'a' is tricky (variable vs article), but in this dataset 'a' is usually a var if followed by operator.
            
            formatted = formatted.replace(/\b([a-zA-Z])\b/g, (match) => {
                if(blacklist.includes(match) && match !== 'a') return match; 
                // Special check for 'a': if it's "a rectangle", it's text. If "5a", it's math.
                // For this specific dataset, 'a' is almost always a variable in the equation part.
                
                // Color Mapping
                let cls = 'var-other';
                if(['x', 'a', 'm', 'p', 'l', 'u'].includes(match)) cls = 'var-x'; // Cyan Group
                else if(['y', 'b', 'n', 'q', 'w', 'v'].includes(match)) cls = 'var-y'; // Pink Group
                else if(['z', 'c', 'k', 'h', 't'].includes(match)) cls = 'var-z'; // Green Group
                
                return `<span class="${cls}">${match}</span>`;
            });
            
            return formatted;
        }

        // --- INPUT HANDLING ---
        function inputNum(val) {
            if(state.isProcessing) return;
            if(state.currentInput.length > 6) return;
            state.currentInput += val;
            updateInputUI();
        }

        function inputAction(action) {
            if(state.isProcessing) return;
            if(action === 'BACK') state.currentInput = state.currentInput.slice(0, -1);
            updateInputUI();
        }

        function updateInputUI() {
            document.getElementById('user-input').innerText = state.currentInput;
        }

        function submitAnswer() {
            if(state.isProcessing || state.currentInput === "") return;
            
            const userAns = parseInt(state.currentInput);
            const correctAns = state.currentProblem.a;
            
            state.isProcessing = true; // Lock input

            if(userAns === correctAns) {
                handleSuccess();
            } else {
                handleFail(userAns);
            }
        }

        function handleSuccess() {
            state.isSolved = true;
            state.streak++;
            document.getElementById('streak-count').innerText = state.streak;
            
            // Visuals
            const inp = document.getElementById('user-input');
            inp.classList.add('success');
            document.getElementById('feedback-msg').innerText = "Correct! Analysis loaded below.";
            document.getElementById('feedback-msg').style.color = "var(--accent-success)";
            
            if(state.streak % 5 === 0) confettiBurst();

            showSolution();
        }

        function handleFail(val) {
            state.isSolved = true;
            state.streak = 0;
            document.getElementById('streak-count').innerText = 0;
            
            const inp = document.getElementById('user-input');
            inp.classList.add('error');
            document.getElementById('feedback-msg').innerText = `Not quite. The answer is ${state.currentProblem.a}.`;
            document.getElementById('feedback-msg').style.color = "var(--accent-danger)";
            
            showSolution();
        }

        function showSolution() {
            document.getElementById('keypad').style.display = 'none';
            document.getElementById('solution-area').classList.add('active');
            
            const container = document.getElementById('steps-container');
            container.innerHTML = '';
            
            const steps = state.currentProblem.steps;
            
            // Animate steps one by one
            steps.forEach((step, index) => {
                const el = document.createElement('div');
                el.className = 'step-item';
                el.innerHTML = `
                    <div class="step-badge">${step.l}</div>
                    <div class="step-content">${formatMathExpression(step.m)}</div>
                `;
                container.appendChild(el);
                
                setTimeout(() => {
                    el.classList.add('visible');
                }, index * 600);
            });

            setTimeout(() => {
                document.getElementById('next-btn').style.display = 'block';
            }, steps.length * 600);
        }

        function nextQuestion() {
            loadNextProblem();
        }

        // --- VISUAL FX ---
        function confettiBurst() {
            const canvas = document.getElementById('confetti');
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            
            let particles = [];
            const colors = ['#22d3ee', '#f472b6', '#4ade80', '#fbbf24'];
            
            for(let i=0; i<60; i++) {
                particles.push({
                    x: window.innerWidth/2, 
                    y: window.innerHeight/2,
                    vx: (Math.random()-0.5)*15, 
                    vy: (Math.random()-0.5)*15,
                    color: colors[Math.floor(Math.random()*colors.length)],
                    life: 100
                });
            }
            
            function animate() {
                ctx.clearRect(0,0,canvas.width,canvas.height);
                let active = false;
                particles.forEach(p => {
                    if(p.life > 0) {
                        p.x += p.vx;
                        p.y += p.vy;
                        p.vy += 0.5; // gravity
                        p.life--;
                        ctx.fillStyle = p.color;
                        ctx.fillRect(p.x, p.y, 6, 6);
                        active = true;
                    }
                });
                if(active) requestAnimationFrame(animate);
            }
            animate();
        }

    </script>
</body>
</html>
